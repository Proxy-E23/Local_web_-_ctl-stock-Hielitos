<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Precios</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilos espec√≠ficos para precios con edici√≥n inline */
    .tabla-header.precios {
      display: grid !important;
      grid-template-columns: 80px 1fr 120px !important;
    }

    .tabla-fila.precios {
      display: grid !important;
      grid-template-columns: 80px 1fr 120px !important;
      transition: background-color 0.3s ease;
    }

    .checkbox-editable-precio {
      transform: scale(1.2);
      cursor: pointer;
    }

    .checkbox-editable-precio:hover {
      transform: scale(1.3);
    }

    /* Estilos para modo edici√≥n */
    .fila-editando-precio {
      background-color: #fff3cd !important;
      border: 2px solid #ffc107 !important;
      border-radius: 5px;
      margin: 2px 0;
    }

    .botones-edicion-precio {
      display: flex;
      gap: 0.3rem;
      justify-content: center;
      align-items: center;
    }

    .btn-confirmar-inline,
    .btn-borrar-inline,
    .btn-cancelar-inline {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .btn-confirmar-inline {
      background-color: #28a745;
      color: white;
    }

    .btn-confirmar-inline:hover {
      background-color: #218838;
      transform: scale(1.05);
    }

    .btn-borrar-inline {
      background-color: #dc3545;
      color: white;
    }

    .btn-borrar-inline:hover {
      background-color: #c82333;
      transform: scale(1.05);
    }

    .btn-cancelar-inline {
      background-color: #6c757d;
      color: white;
    }

    .btn-cancelar-inline:hover {
      background-color: #545b62;
      transform: scale(1.05);
    }

    .precio-activo {
      color: #28a745;
      font-weight: bold;
    }

    .precio-inactivo {
      color: #6c757d;
    }

    .precio-era-activo {
      color: #dc3545;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .tabla-header.precios,
      .tabla-fila.precios {
        grid-template-columns: 70px 1fr 100px !important;
      }
      
      .btn-confirmar-inline,
      .btn-borrar-inline,
      .btn-cancelar-inline {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Precios</h1>
  </header>

  <main class="container">
    <div class="botones-superiores">
      <button class="btn-volver" onclick="window.location.href='index.html'">‚Üê Atr√°s</button>
    </div>

    <form id="precioForm">
      <label for="precio">Precio:</label>
      <input type="number" id="precio" name="precio" step="0.01" min="0" required />

      <label class="checkbox-label">
        <input type="checkbox" id="actual" checked />
        Precio actual
      </label>

      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" required />

      <button type="submit">Agregar precio</button>
    </form>

    <div class="lista-sabores">
      <h3>Historial de precios:</h3>
      <div class="tabla-sabores">
        <div class="tabla-header precios" style="display: grid; grid-template-columns: 80px 1fr 120px; background-color: #4ecdc4; color: white; font-weight: bold; padding: 0.8rem 0;">
          <div style="padding: 0 0.8rem; display: flex; align-items: center; text-align: center; justify-content: center;">Estado</div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center;">Precio</div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; text-align: center; justify-content: center;">Fecha</div>
        </div>
        <div id="listaPrecios" class="tabla-body"></div>
      </div>

      <!-- Bot√≥n de borrar todo despu√©s de la tabla -->
      <div style="display: flex; justify-content: center; margin-top: 2rem;">
        <button type="button" onclick="confirmarBorrado()" style="padding: 0.8rem 2rem; font-size: 1rem; border: none; border-radius: 5px; background-color: #dc3545; color: white; cursor: pointer; transition: background-color 0.3s ease;">
          üóë Borrar todos los precios
        </button>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById("precioForm");
    const fechaInput = document.getElementById("fecha");
    const listaPrecios = document.getElementById("listaPrecios");

    let filaEnEdicionPrecio = null;
    let estadoOriginal = null;

    fechaInput.valueAsDate = new Date();

    function generarID(precios) {
      let max = 0;
      precios.forEach((p) => {
        const num = parseInt(p.id.replace("pr", ""));
        if (!isNaN(num) && num > max) max = num;
      });
      const next = (max + 1).toString().padStart(3, "0");
      return `pr${next}`;
    }

    function renderizarLista() {
      const precios = JSON.parse(localStorage.getItem("precios_hielitos")) || [];
      precios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); // Ordenar por fecha m√°s reciente
      listaPrecios.innerHTML = "";
      
      if (precios.length === 0) {
        listaPrecios.innerHTML = '<div class="no-sabores">No hay precios registrados</div>';
        return;
      }
      
      precios.forEach(precio => {
        // Convertir fecha de YYYY-MM-DD a DD/MM/YYYY
        const fechaFormateada = precio.fecha.split('-').reverse().join('/');
        
        const fila = document.createElement("div");
        fila.className = "tabla-fila precios";
        fila.id = `fila_precio_${precio.id}`;
        fila.style.display = "grid";
        fila.style.gridTemplateColumns = "80px 1fr 120px";
        fila.style.padding = "0.8rem 0";
        fila.style.borderBottom = "1px solid #eee";
        
        fila.innerHTML = `
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center;">
            <input type="checkbox" class="checkbox-editable-precio" ${precio.actual ? 'checked' : ''} 
                   onclick="iniciarEdicionPrecio('${precio.id}', ${precio.actual})" />
          </div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center;" class="${precio.actual ? 'precio-activo' : 'precio-inactivo'}">
            $${parseFloat(precio.precio).toFixed(2)}
          </div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; text-align: center; justify-content: center; color: #666; font-size: 0.9rem;">
            ${fechaFormateada}
          </div>
        `;
        listaPrecios.appendChild(fila);
      });
    }

    function iniciarEdicionPrecio(precioId, estadoActual) {
      // Si ya hay una fila en edici√≥n, cancelar esa primero
      if (filaEnEdicionPrecio) {
        cancelarEdicionPrecio();
      }

      filaEnEdicionPrecio = precioId;
      estadoOriginal = estadoActual;
      
      const fila = document.getElementById(`fila_precio_${precioId}`);
      const checkbox = fila.querySelector('.checkbox-editable-precio');
      const nuevoEstado = checkbox.checked;
      
      // Agregar clase de edici√≥n
      fila.classList.add('fila-editando-precio');
      
      // Si se est√° activando este precio, resaltar en rojo y desmarcar el que estaba activo
      if (nuevoEstado && !estadoOriginal) {
        const precios = JSON.parse(localStorage.getItem("precios_hielitos")) || [];
        const precioActivoAnterior = precios.find(p => p.actual && p.id !== precioId);
        
        if (precioActivoAnterior) {
          const filaAnterior = document.getElementById(`fila_precio_${precioActivoAnterior.id}`);
          if (filaAnterior) {
            // Resaltar en rojo
            const precioDiv = filaAnterior.children[1];
            precioDiv.className = 'precio-era-activo';
            
            // Desmarcar temporalmente el checkbox
            const checkboxAnterior = filaAnterior.querySelector('.checkbox-editable-precio');
            if (checkboxAnterior) {
              checkboxAnterior.checked = false;
            }
          }
        }
      }
      
      // Cambiar la columna de fecha por botones de acci√≥n
      const fechaDiv = fila.children[2];
      fechaDiv.innerHTML = `
        <div class="botones-edicion-precio">
          <button class="btn-confirmar-inline" onclick="confirmarCambioPrecio('${precioId}')" title="Confirmar">‚úì</button>
          <button class="btn-borrar-inline" onclick="confirmarBorrarPrecio('${precioId}')" title="Borrar">üóë</button>
          <button class="btn-cancelar-inline" onclick="cancelarEdicionPrecio()" title="Cancelar">‚úï</button>
        </div>
      `;
    }

    function confirmarCambioPrecio(precioId) {
      try {
        const precios = JSON.parse(localStorage.getItem("precios_hielitos")) || [];
        const checkbox = document.querySelector(`#fila_precio_${precioId} .checkbox-editable-precio`);
        const nuevoEstado = checkbox.checked;

        // Si no hay cambio de estado, solo salir del modo edici√≥n
        if (nuevoEstado === estadoOriginal) {
          cancelarEdicionPrecio();
          return;
        }

        // Si se marca como activo, desactivar todos los dem√°s
        if (nuevoEstado) {
          precios.forEach(p => {
            if (p.id !== precioId) {
              p.actual = false;
            }
          });
        }

        // Aplicar el cambio al precio seleccionado
        const indice = precios.findIndex(p => p.id === precioId);
        if (indice !== -1) {
          precios[indice].actual = nuevoEstado;
          
          // Guardar cambios
          localStorage.setItem("precios_hielitos", JSON.stringify(precios));

          // Mostrar mensaje de √©xito
          const mensaje = nuevoEstado ? "Precio marcado como activo" : "Precio marcado como inactivo";
          alert(`‚úì ${mensaje}`);
          
          // Salir del modo edici√≥n y rerenderizar
          filaEnEdicionPrecio = null;
          estadoOriginal = null;
          renderizarLista();
        }
      } catch (error) {
        console.error("Error al cambiar estado del precio:", error);
        alert("Error al aplicar los cambios");
      }
    }

    function confirmarBorrarPrecio(precioId) {
      const confirmacion = confirm(
        "¬øEst√°s seguro de que quieres eliminar este precio?\n\nEsta acci√≥n no se puede deshacer."
      );
      
      if (confirmacion) {
        try {
          let precios = JSON.parse(localStorage.getItem("precios_hielitos")) || [];
          
          // Encontrar el precio a eliminar
          const precioAEliminar = precios.find(p => p.id === precioId);
          
          // Filtrar para eliminar el precio
          precios = precios.filter(p => p.id !== precioId);
          
          // Si se elimin√≥ el precio activo y quedan otros precios, preguntar cu√°l activar
          if (precioAEliminar && precioAEliminar.actual && precios.length > 0) {
            const hayOtroActivo = precios.some(p => p.actual);
            if (!hayOtroActivo) {
              alert("‚ö†Ô∏è Se elimin√≥ el precio activo.\nDebes marcar otro precio como activo desde la lista.");
            }
          }
          
          // Guardar cambios
          localStorage.setItem("precios_hielitos", JSON.stringify(precios));
          
          alert("‚úì Precio eliminado correctamente");
          
          // Salir del modo edici√≥n y rerenderizar
          filaEnEdicionPrecio = null;
          estadoOriginal = null;
          renderizarLista();
          
        } catch (error) {
          console.error("Error al eliminar precio:", error);
          alert("Error al eliminar el precio");
        }
      }
    }

    function cancelarEdicionPrecio() {
      if (!filaEnEdicionPrecio) return;
      
      // Restaurar checkbox al estado original
      const checkbox = document.querySelector(`#fila_precio_${filaEnEdicionPrecio} .checkbox-editable-precio`);
      if (checkbox) {
        checkbox.checked = estadoOriginal;
      }
      
      // Salir del modo edici√≥n y rerenderizar
      filaEnEdicionPrecio = null;
      estadoOriginal = null;
      renderizarLista();
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      
      // Si hay una edici√≥n en curso, cancelarla primero
      if (filaEnEdicionPrecio) {
        cancelarEdicionPrecio();
      }
      
      const precio = document.getElementById("precio").value.trim();
      const actual = document.getElementById("actual").checked;
      const fecha = document.getElementById("fecha").value;

      let precios = JSON.parse(localStorage.getItem("precios_hielitos")) || [];

      // Si se marca como precio actual, desmarcar todos los dem√°s
      if (actual) {
        precios.forEach(p => p.actual = false);
      }

      const id = generarID(precios);
      precios.push({ id, precio: parseFloat(precio), actual, fecha });
      localStorage.setItem("precios_hielitos", JSON.stringify(precios));
      form.reset();
      fechaInput.valueAsDate = new Date();
      renderizarLista();
    });

    function confirmarBorrado() {
      const confirmacion = confirm(
        "‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEsto borrar√° TODOS los precios guardados.\n\n¬øEst√°s seguro de continuar?"
      );
      if (confirmacion) {
        // Cancelar edici√≥n si est√° activa
        if (filaEnEdicionPrecio) {
          filaEnEdicionPrecio = null;
          estadoOriginal = null;
        }
        
        localStorage.removeItem("precios_hielitos");
        alert("Precios borrados correctamente.");
        renderizarLista();
      }
    }

    // Cerrar edici√≥n al hacer clic fuera
    document.addEventListener("click", function(e) {
      // Si hay edici√≥n activa y el click no es en la fila en edici√≥n ni en sus elementos
      if (filaEnEdicionPrecio && !e.target.closest(`#fila_precio_${filaEnEdicionPrecio}`)) {
        cancelarEdicionPrecio();
      }
    });

    // Manejar tecla Escape para cancelar edici√≥n
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && filaEnEdicionPrecio) {
        cancelarEdicionPrecio();
      }
    });

    window.addEventListener("DOMContentLoaded", renderizarLista);
  </script>
</body>
</html>