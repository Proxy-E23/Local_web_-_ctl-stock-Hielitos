<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Corregir tabla inventario - Centrado limpio con columnas optimizadas */
    .tabla-header.inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
    }

    .tabla-fila.inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
    }

    /* Centrado espec√≠fico para columnas de stock y acci√≥n */
    .col-stock {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: bold !important;
      color: #4ecdc4 !important;
    }

    .col-accion {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    @media (max-width: 768px) {
      .tabla-header.inventario,
      .tabla-fila.inventario {
        grid-template-columns: 1fr 50px 50px !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventario</h1>
  </header>

  <main class="container">
    <div class="botones-superiores">
      <button class="btn-volver" onclick="window.location.href='index.html'">‚Üê Atr√°s</button>
      <button class="btn-borrar" onclick="mostrarHistorial()">üìä Historial</button>
    </div>

    <div class="lista-sabores">
      <h3>Stock de sabores disponibles:</h3>
      <div class="tabla-sabores">
        <div class="tabla-header inventario" style="display: grid; grid-template-columns: 1fr 60px 60px; background-color: #4ecdc4; color: white; font-weight: bold; padding: 0.8rem 0;">
          <div style="padding: 0 0.8rem; display: flex; align-items: center; cursor: pointer;" onclick="ordenarPorSabor()">Sabor ‚ÜïÔ∏è</div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="ordenarPorStock()">Stock <span id="indicadorOrden">‚ÜïÔ∏è</span></div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center;"></div>
        </div>
        <div id="tablaInventario" class="tabla-body"></div>
      </div>

      <!-- Bot√≥n de borrar inventario despu√©s de la tabla -->
      <div style="display: flex; justify-content: center; margin-top: 2rem;">
        <button type="button" onclick="confirmarBorradoInventario()" style="padding: 0.8rem 2rem; font-size: 1rem; border: none; border-radius: 5px; background-color: #dc3545; color: white; cursor: pointer; transition: background-color 0.3s ease;">
          üóë Borrar inventario completo
        </button>
      </div>
    </div>

    <!-- Modal para editar stock -->
    <div id="modalStock" class="modal oculto">
      <div class="modal-content">
        <h4 id="modalTitulo">Agregar stock</h4>
        <div class="modal-body">
          <label for="cantidadInput">Cantidad a agregar:</label>
          <input type="number" id="cantidadInput" min="1" inputmode="numeric" />
          <div class="modal-botones">
            <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
            <button class="btn-confirmar" onclick="confirmarStock()">‚úÖ Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal oculto">
      <div class="modal-content">
        <h4>Confirmar operaci√≥n</h4>
        <div class="modal-body">
          <p id="mensajeConfirmacion"></p>
          <div class="modal-botones">
            <button class="btn-cancelar" onclick="cancelarOperacion()">Cancelar</button>
            <button class="btn-confirmar" onclick="ejecutarOperacion()">Continuar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal historial -->
    <div id="modalHistorial" class="modal oculto">
      <div class="modal-content modal-grande">
        <h4>Historial de movimientos</h4>
        <div class="modal-body">
          <!-- Navegaci√≥n por d√≠as -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem; background-color: #f8f9fa; border-radius: 5px;">
            <button id="btnDiaAnterior" onclick="cambiarDia(-1)" style="padding: 0.3rem 0.8rem; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">‚Üê Anterior</button>
            <div id="fechaActualHistorial" style="font-weight: bold; color: #333;"></div>
            <button id="btnDiaSiguiente" onclick="cambiarDia(1)" style="padding: 0.3rem 0.8rem; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">Siguiente ‚Üí</button>
          </div>
          
          <div id="listaHistorial"></div>
          <div class="modal-botones">
            <button class="btn-confirmar" onclick="cerrarHistorial()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let saborActual = null;
    let cantidadPendiente = 0;
    let ordenActual = 'alfabetico'; // 'alfabetico', 'stock-asc', 'stock-desc'
    let fechaHistorialActual = null; // Nueva variable para controlar la fecha del historial
    let diasConMovimientos = []; // Array con todas las fechas que tienen movimientos
    const tablaInventario = document.getElementById("tablaInventario");

    function cargarSabores() {
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      // FILTRAR SOLO SABORES DISPONIBLES PARA VENTA
      const saboresDisponibles = sabores.filter(sabor => sabor.disponible === true);
      
      tablaInventario.innerHTML = "";
      
      if (saboresDisponibles.length === 0) {
        tablaInventario.innerHTML = '<div class="no-sabores">No hay sabores disponibles para inventario.<br>Marca algunos sabores como "disponibles" en la secci√≥n Sabores.</div>';
        return;
      }
      
      // Crear array con sabor y stock para ordenar
      let saboresConStock = saboresDisponibles.map(sabor => ({
        ...sabor,
        stock: inventario[sabor.id] ? inventario[sabor.id].stock : 0
      }));
      
      // Aplicar ordenamiento seg√∫n el estado actual
      switch(ordenActual) {
        case 'alfabetico':
          saboresConStock.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
          document.getElementById('indicadorOrden').textContent = '‚ÜïÔ∏è';
          break;
        case 'stock-asc':
          saboresConStock.sort((a, b) => a.stock - b.stock);
          document.getElementById('indicadorOrden').textContent = '‚Üë';
          break;
        case 'stock-desc':
          saboresConStock.sort((a, b) => b.stock - a.stock);
          document.getElementById('indicadorOrden').textContent = '‚Üì';
          break;
      }
      
      saboresConStock.forEach(sabor => {
        const fila = document.createElement("div");
        fila.className = "tabla-fila inventario";
        fila.style.display = "grid";
        fila.style.gridTemplateColumns = "1fr 60px 60px";
        fila.style.padding = "0.8rem 0";
        fila.style.borderBottom = "1px solid #eee";
        fila.innerHTML = `
          <div style="padding: 0 0.8rem; display: flex; align-items: center;">${sabor.nombre}</div>
          <div class="col-stock" style="padding: 0 0.8rem;">${sabor.stock}</div>
          <div class="col-accion" style="padding: 0 0.8rem;">
            <button class="btn-editar" onclick="editarStock('${sabor.id}', '${sabor.nombre}')">‚úèÔ∏è</button>
          </div>
        `;
        tablaInventario.appendChild(fila);
      });
    }

    function ordenarPorSabor() {
      ordenActual = 'alfabetico';
      cargarSabores();
    }

    function ordenarPorStock() {
      if (ordenActual === 'alfabetico' || ordenActual === 'stock-desc') {
        ordenActual = 'stock-asc'; // Menor a mayor
      } else if (ordenActual === 'stock-asc') {
        ordenActual = 'stock-desc'; // Mayor a menor
      }
      cargarSabores();
    }

    function editarStock(saborId, saborNombre) {
      saborActual = { id: saborId, nombre: saborNombre };
      document.getElementById("modalTitulo").textContent = `Agregar stock - ${saborNombre}`;
      document.getElementById("cantidadInput").value = "";
      document.getElementById("modalStock").classList.remove("oculto");
      document.getElementById("cantidadInput").focus();
    }

    function cerrarModal() {
      document.getElementById("modalStock").classList.add("oculto");
      document.getElementById("modalConfirmacion").classList.add("oculto");
      saborActual = null;
      cantidadPendiente = 0;
    }

    function confirmarStock() {
      const cantidad = parseInt(document.getElementById("cantidadInput").value);
      
      if (!cantidad || cantidad <= 0) {
        alert("Ingrese una cantidad v√°lida");
        return;
      }

      cantidadPendiente = cantidad;
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const stockActual = inventario[saborActual.id] ? inventario[saborActual.id].stock : 0;
      const nuevoStock = stockActual + cantidad;

      document.getElementById("mensajeConfirmacion").innerHTML = `
        Se van a anexar <strong>${cantidad}</strong> unidades a <strong>${saborActual.nombre}</strong><br>
        Resultado: <strong>${nuevoStock}</strong> en stock
      `;
      
      document.getElementById("modalStock").classList.add("oculto");
      document.getElementById("modalConfirmacion").classList.remove("oculto");
    }

    function cancelarOperacion() {
      cerrarModal();
    }

    function ejecutarOperacion() {
      if (!saborActual || !cantidadPendiente) return;

      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const fechaHora = new Date();
      const fecha = fechaHora.toISOString().split('T')[0];
      const hora = fechaHora.toTimeString().split(' ')[0].substring(0, 5);
      
      if (!inventario[saborActual.id]) {
        inventario[saborActual.id] = {
          sabor: saborActual.nombre,
          stock: 0,
          historial: []
        };
      }

      inventario[saborActual.id].stock += cantidadPendiente;
      inventario[saborActual.id].historial.push({
        fecha: fecha,
        hora: hora,
        cantidad: cantidadPendiente,
        tipo: "entrada",
        stockResultante: inventario[saborActual.id].stock
      });

      localStorage.setItem("inventario_hielitos", JSON.stringify(inventario));
      
      cerrarModal();
      cargarSabores();
      
      // Notificaci√≥n de √©xito
      alert(`Stock actualizado correctamente\n${saborActual.nombre}: ${inventario[saborActual.id].stock} unidades`);
    }

    function mostrarHistorial() {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      // Recopilar todos los movimientos y obtener fechas √∫nicas
      let historialCompleto = [];
      Object.values(inventario).forEach(item => {
        item.historial.forEach(mov => {
          historialCompleto.push({
            sabor: item.sabor,
            ...mov
          });
        });
      });
      
      if (historialCompleto.length === 0) {
        document.getElementById("listaHistorial").innerHTML = '<p class="no-sabores">No hay movimientos registrados</p>';
        document.getElementById("modalHistorial").classList.remove("oculto");
        return;
      }
      
      // Obtener fechas √∫nicas y ordenarlas de m√°s reciente a m√°s antigua
      diasConMovimientos = [...new Set(historialCompleto.map(mov => mov.fecha))];
      diasConMovimientos.sort((a, b) => new Date(b) - new Date(a));
      
      // Si no hay fecha seleccionada, usar la m√°s reciente
      if (!fechaHistorialActual || !diasConMovimientos.includes(fechaHistorialActual)) {
        fechaHistorialActual = diasConMovimientos[0];
      }
      
      cargarMovimientosDia(fechaHistorialActual);
      document.getElementById("modalHistorial").classList.remove("oculto");
    }

    function cargarMovimientosDia(fecha) {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const listaHistorial = document.getElementById("listaHistorial");
      
      // Filtrar movimientos solo de la fecha seleccionada
      let movimientosDelDia = [];
      Object.values(inventario).forEach(item => {
        item.historial.forEach(mov => {
          if (mov.fecha === fecha) {
            movimientosDelDia.push({
              sabor: item.sabor,
              ...mov
            });
          }
        });
      });
      
      // Ordenar por hora (m√°s reciente primero)
      movimientosDelDia.sort((a, b) => {
        const horaA = a.hora || '00:00';
        const horaB = b.hora || '00:00';
        return horaB.localeCompare(horaA);
      });
      
      // Actualizar t√≠tulo con fecha actual
      const fechaFormateada = fecha.split('-').reverse().join('/');
      document.getElementById("fechaActualHistorial").textContent = `Movimientos del ${fechaFormateada}`;
      
      // Actualizar estado de botones de navegaci√≥n
      const indiceFechaActual = diasConMovimientos.indexOf(fecha);
      document.getElementById("btnDiaAnterior").disabled = indiceFechaActual >= diasConMovimientos.length - 1;
      document.getElementById("btnDiaSiguiente").disabled = indiceFechaActual <= 0;
      
      // Aplicar estilos de botones deshabilitados
      const btnAnterior = document.getElementById("btnDiaAnterior");
      const btnSiguiente = document.getElementById("btnDiaSiguiente");
      
      btnAnterior.style.opacity = btnAnterior.disabled ? "0.5" : "1";
      btnAnterior.style.cursor = btnAnterior.disabled ? "not-allowed" : "pointer";
      
      btnSiguiente.style.opacity = btnSiguiente.disabled ? "0.5" : "1";
      btnSiguiente.style.cursor = btnSiguiente.disabled ? "not-allowed" : "pointer";
      
      // Mostrar movimientos del d√≠a
      if (movimientosDelDia.length === 0) {
        listaHistorial.innerHTML = '<p class="no-sabores">No hay movimientos en esta fecha</p>';
      } else {
        listaHistorial.innerHTML = movimientosDelDia.map(mov => {
          const horaTexto = mov.hora || '00:00';
          const tipoTexto = mov.tipo === 'entrada' ? '+' : '';
          const colorTipo = mov.tipo === 'entrada' ? '#4ecdc4' : '#dc3545';
          
          return `
            <div style="display: grid; grid-template-columns: 60px 1fr 60px 80px; gap: 0.5rem; padding: 0.4rem 0; border-bottom: 1px solid #eee; align-items: center;">
              <div style="font-size: 0.9rem; color: #666; text-align: center; font-weight: 500;">${horaTexto}</div>
              <div style="font-weight: 500;">${mov.sabor}</div>
              <div style="color: ${colorTipo}; font-weight: bold; text-align: center;">${tipoTexto}${mov.cantidad}</div>
              <div style="color: #666; text-align: center; font-size: 0.9rem;">Stock: ${mov.stockResultante}</div>
            </div>
          `;
        }).join('');
      }
    }

    function cambiarDia(direccion) {
      const indiceActual = diasConMovimientos.indexOf(fechaHistorialActual);
      const nuevoIndice = indiceActual + direccion;
      
      if (nuevoIndice >= 0 && nuevoIndice < diasConMovimientos.length) {
        fechaHistorialActual = diasConMovimientos[nuevoIndice];
        cargarMovimientosDia(fechaHistorialActual);
      }
    }

    function cerrarHistorial() {
      document.getElementById("modalHistorial").classList.add("oculto");
      // Resetear la fecha al cerrar para que siempre abra en la m√°s reciente
      fechaHistorialActual = null;
    }

    function confirmarBorradoInventario() {
      const confirmacion = confirm(
        "‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEsto borrar√° TODO el inventario (stock y historial).\nLos SABORES se mantendr√°n intactos.\n\n¬øEst√°s seguro de continuar?"
      );
      if (confirmacion) {
        localStorage.removeItem("inventario_hielitos");
        alert("Inventario borrado correctamente.\nLos sabores se mantienen intactos.");
        cargarSabores();
      }
    }

    // Cerrar modales al hacer clic fuera
    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("modal")) {
        cerrarModal();
        cerrarHistorial();
      }
    });

    window.addEventListener("DOMContentLoaded", cargarSabores);
  </script>
</body>
</html>