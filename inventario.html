<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario</title>
  <link rel="stylesheet" href="style.css" />
  <style>
  
    /* Corregir tabla inventario - Centrado limpio con columnas optimizadas (ACTUALIZADO: 2 COLUMNAS) */
    .tabla-header.inventario {
      display: grid !important;
      grid-template-columns: 1fr 80px !important;
    }
    
      .tabla-fila.inventario {
      display: grid !important;
      grid-template-columns: 1fr 80px !important;
    }

/* Centrado espec√≠fico para columna de stock */
    .col-stock {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: bold !important;
      color: #4ecdc4 !important;
    }

    .col-accion {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* BOTONES DE NAVEGACI√ìN DEL HISTORIAL - ESTILO CORREGIDO */
    .btn-navegacion-historial {
      padding: 0.7rem 1rem !important;
      background-color: #4ecdc4 !important;
      color: white !important;
      border: none !important;
      border-radius: 5px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      font-size: 1.3rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .btn-navegacion-historial:hover:not(:disabled) {
      background-color: #3da9a1 !important;
      transform: translateY(-1px) !important;
    }

    .btn-navegacion-historial:disabled {
      background-color: #6c757d !important;
      opacity: 0.6 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }

    /* Contenedor de navegaci√≥n del historial */
    .navegacion-historial {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      margin-bottom: 1rem !important;
      padding: 0.8rem !important;
      background-color: #f8f9fa !important;
      border-radius: 5px !important;
    }

    .fecha-historial-info {
      text-align: center !important;
      flex-grow: 1 !important;
    }

    .fecha-historial-titulo {
      font-size: 1.1rem !important;
      font-weight: bold !important;
      color: #333 !important;
      margin-bottom: 0.2rem !important;
    }

    .fecha-historial-valor {
      font-size: 1rem !important;
      font-weight: 600 !important;
      color: #4ecdc4 !important;
    }

    /* ===== ESTILOS PARA MODAL HISTORIAL FIJO SUPERIOR ===== */
    #modalHistorial {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: flex-start !important;
      padding-top: 2rem !important;
      box-sizing: border-box;
    }

    #modalHistorial .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      min-height: 300px !important;
      max-height: calc(100vh - 2rem) !important;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #modalHistorial .modal-content h4 {
      margin: 0;
      padding: 1.5rem 1.5rem 1rem 1.5rem;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }

    #modalHistorial .modal-body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 240px);
    }

    #modalHistorial .navegacion-historial {
      flex-shrink: 0;
      margin-bottom: 1rem;
    }

    #modalHistorial #listaHistorial {
      flex-grow: 1;
      min-height: 100px;
      max-height: calc(100vh - 320px);
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: white;
    }

    #modalHistorial .modal-botones {
      flex-shrink: 0;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }

    /* ===== ESTILOS PARA MODAL A√ëADIR STOCK ===== */
    #modalA√±adirStock {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: flex-start !important;
      padding-top: 2rem !important;
      box-sizing: border-box;
    }

    #modalA√±adirStock .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      min-height: 300px !important;
      max-height: calc(100vh - 2rem) !important;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #modalA√±adirStock .modal-content h4 {
      margin: 0;
      padding: 1.5rem 1.5rem 1rem 1.5rem;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }

    #modalA√±adirStock .modal-body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 240px);
    }

    .fecha-stock-selector {
      margin-bottom: 1.5rem;
    }

    .fecha-stock-selector label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .fecha-stock-input {
      width: 100%;
      max-width: 200px;
      padding: 0.7rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      margin: 0 auto;
      display: block;
    }

    .fecha-stock-input:focus {
      border-color: #4ecdc4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .btn-seleccionar-sabores {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #4ecdc4;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .btn-seleccionar-sabores:hover {
      background-color: #3da9a1;
    }

    /* ===== ESTILOS PARA FORMULARIO DIN√ÅMICO DE STOCK (FASE 2) ===== */
    .formulario-sabores-stock {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .formulario-sabores-stock h5 {
      margin: 0 0 1rem 0;
      color: #333;
      text-align: center;
    }

    /* TABLA INVISIBLE para alineamiento perfecto */
    .tabla-stock {
      width: 100%;
      border-collapse: collapse;
    }

    .tabla-stock td {
      padding: 0.3rem 0.3rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      height: 2.2rem;
    }

    .tabla-stock tr:last-child td {
      border-bottom: none;
    }

    /* Columna del bot√≥n X - centrada */
    .col-eliminar-stock {
      width: 40px;
      text-align: center;
      vertical-align: middle !important;
    }

    /* Columna del sabor - alineada a la izquierda */
    .col-sabor-stock {
      text-align: left;
      padding-left: 0.5rem !important;
      vertical-align: middle !important;
    }

    /* Columna del input - centrada */
    .col-cantidad-stock {
      width: 80px;
      text-align: center;
      vertical-align: middle !important;
    }

    /* MODIFICACIONES: Bot√≥n X - M√°s compacto, sin borde rojo, casi del tama√±o del emoji */
    .btn-eliminar-sabor-stock {
      background: #f8f9fa !important;
      color: #dc3545 !important;
      border: none !important;
      border-radius: 3px;
      padding: 0.1rem !important;
      cursor: pointer;
      font-size: 0.9rem !important;
      transition: all 0.2s ease;
      width: 24px !important;
      height: 24px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none !important;
    }

    .btn-eliminar-sabor-stock:hover {
      background: #dc3545 !important;
      color: white !important;
      transform: scale(1.05) !important;
    }

    .sabor-stock-nombre {
      font-weight: 500;
      color: #333;
      line-height: 1.3 !important;
      margin: 0 !important;
      padding: 0 !important;
      display: inline-block !important;
    }

    /* MODIFICACIONES: Input de cantidad - Altura reducida para coincidir con el texto */
    .input-cantidad-stock {
      width: 60px;
      padding: 0.25rem 0.3rem !important;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: center;
      background-color: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      height: 1.8rem !important;
      line-height: 1.3 !important;
      margin: 0 !important;
      vertical-align: middle !important;
    }

    .input-cantidad-stock:focus {
      border-color: #4ecdc4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .mensaje-sin-sabores {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 1rem;
    }

    /* ===== ESTILOS PARA MODAL SELECTOR DE SABORES ===== */
    #modalSelectorSabores {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1100;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #modalSelectorSabores .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 500px;
      max-height: 70vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .lista-sabores-selector {
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .sabor-item-selector {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }

    .sabor-item-selector:hover {
      background-color: #f8f9fa;
    }

    .sabor-item-selector:last-child {
      border-bottom: none;
    }

    .sabor-checkbox {
      transform: scale(1.2);
      cursor: pointer;
    }

    .sabor-nombre {
      flex-grow: 1;
      font-weight: 500;
      color: #333;
    }

    /* ===== ESTILOS PARA MODAL CORRECCI√ìN DE STOCK ===== */
    #modalCorreccionStock {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 2rem;
      box-sizing: border-box;
    }

    #modalCorreccionStock .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 500px;
      min-height: 300px;
      max-height: calc(100vh - 2rem);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #modalCorreccionStock .modal-content h4 {
      margin: 0;
      padding: 1.5rem 1.5rem 1rem 1.5rem;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }

    #modalCorreccionStock .modal-body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* Stock actual - FORMATO EN UNA L√çNEA */
    .stock-actual-info {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      text-align: center;
      border: 2px solid #dee2e6;
    }

    .stock-actual-contenido {
      font-size: 1.1rem;
      font-weight: 600;
      color: #495057;
      margin: 0;
    }

    .stock-actual-numero {
      color: #4ecdc4;
      font-weight: bold;
    }

    /* Selector de tipo de correcci√≥n */
    .tipo-correccion {
      margin-bottom: 1.5rem;
    }

    .tipo-correccion label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    /* Radio buttons - DISE√ëO EN UNA L√çNEA */
    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.6rem 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
      justify-content: flex-start; /* Alineado a la izquierda */
    }

    .radio-option:hover {
      background-color: #f8f9fa;
      border-color: #4ecdc4;
    }

    .radio-option input[type="radio"] {
      margin: 0;
      order: 2; /* Radio button al final */
    }

    .radio-option label {
      order: 1; /* Texto al inicio */
      margin: 0;
      flex-grow: 1;
      cursor: pointer;
      text-align: left;
    }

    .radio-option.selected {
      background-color: #e8f5f4;
      border-color: #4ecdc4;
      color: #2c7a73;
    }

    /* Input de cantidad - EN UNA L√çNEA */
    .cantidad-correccion {
      margin-bottom: 1.5rem;
    }

    .cantidad-fila {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .cantidad-correccion label {
      font-weight: 600;
      color: #333;
      margin: 0;
      white-space: nowrap;
    }

    .input-cantidad-correccion {
      flex: 1;
      max-width: 120px;
      padding: 0.7rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      text-align: center;
    }

    .input-cantidad-correccion:focus {
      border-color: #4ecdc4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    /* Preview del resultado - EN UNA L√çNEA */
    .resultado-preview {
      background-color: #e8f5f4;
      border: 2px solid #4ecdc4;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .resultado-preview.visible {
      opacity: 1;
    }

    .resultado-contenido {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c7a73;
      margin: 0;
    }

    .resultado-numero {
      font-weight: bold;
      font-size: 1.2rem;
    }

    /* Selector de motivo */
    .motivo-correccion {
      margin-bottom: 1.5rem;
    }

    .motivo-correccion label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .select-motivo {
      width: 100%;
      padding: 0.7rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
    }

    .select-motivo:focus {
      border-color: #4ecdc4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .input-motivo-otro {
      width: 100%;
      padding: 0.7rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      margin-top: 0.5rem;
      display: none;
    }

    .input-motivo-otro:focus {
      border-color: #4ecdc4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .input-motivo-otro.visible {
      display: block;
    }

    /* ===== ESTILOS PARA EL NUEVO FORMATO DE HISTORIAL DE INVENTARIO MODIFICADO ===== */
    .movimiento-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .movimiento-hora {
      background-color: #f8f9fa;
      padding: 0.6rem 1rem;
      border-bottom: 2px solid #ddd;
      text-align: left;
      font-weight: bold;
      color: #495057;
      font-size: 1rem;
    }

    .movimientos-items {
      background-color: white;
    }

    /* MODIFICACI√ìN: Nuevo grid con columnas optimizadas: Sabor (resto), Hielitos (60px), Stock (60px) */
    .movimiento-item {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
      gap: 1rem !important;
      padding: 0.4rem 1rem !important;
      border-bottom: 1px solid #f0f0f0 !important;
      transition: background-color 0.2s ease !important;
    }

    .movimiento-item:hover {
      background-color: #f8f9fa;
    }

    .movimiento-item:last-child {
      border-bottom: none;
    }

    /* MODIFICACI√ìN: Sabor alineado a la izquierda y centrado verticalmente */
    .item-sabor-inventario {
      text-align: left !important;
      line-height: 1.3 !important;
      color: #333 !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
    }

    /* MODIFICACI√ìN: Hielitos centrado con ancho fijo para 3 d√≠gitos */
    .item-cantidad-inventario {
      text-align: center !important;
      font-weight: bold !important;
      width: 60px !important;
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .item-cantidad-entrada {
      color: #4ecdc4;
    }

    .item-cantidad-venta {
      color: #dc3545;
    }

    .item-cantidad-correccion {
      color: #ffc107;
    }

    /* MODIFICACI√ìN: Stock centrado con ancho fijo para 3 d√≠gitos */
    .item-stock-inventario {
      text-align: center !important;
      color: #666 !important;
      width: 60px !important;
      font-size: 0.9rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .movimientos-totales {
      background-color: #f8f9fa;
      padding: 0.6rem 1rem;
      border-top: 1px solid #ddd;
    }

    /* MODIFICACI√ìN: Total con nuevo grid - etiqueta alineada a la derecha en columna sabor, valor en columna hielitos */
    .total-fila-inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
      gap: 1rem !important;
    }

    /* MODIFICACI√ìN: Etiqueta del total alineada a la derecha en la columna de sabores */
    .total-etiqueta-inventario {
      text-align: right !important;
      color: #666 !important;
      font-weight: 500 !important;
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: flex-end !important;
    }

    /* MODIFICACI√ìN: Valor del total centrado en la columna de hielitos con color din√°mico seg√∫n tipo de movimiento */
    .total-valor-inventario {
      text-align: center !important;
      font-weight: bold !important;
      width: 60px !important;
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* Colores din√°micos para totales seg√∫n tipo de movimiento predominante */
    .total-valor-entradas {
      color: #4ecdc4 !important;
    }

    .total-valor-ventas {
      color: #dc3545 !important;
    }

    .total-valor-mixto {
      color: #6f42c1 !important;
    }

    .total-valor-correcciones {
      color: #ffc107 !important;
    }

    /* MODIFICACI√ìN: Columna vac√≠a para completar el grid (donde estar√≠a stock) */
    .total-columna-vacia {
      width: 60px !important;
    }

    /* Separadores visuales */
    .separador-inventario {
      height: 1px;
      background-color: #ddd;
      margin: 0;
    }

    @media (max-width: 768px) {
      .tabla-header.inventario,
      .tabla-fila.inventario {
        grid-template-columns: 1fr 50px 50px !important;
      }
      
      .btn-navegacion-historial {
        padding: 0.6rem 0.8rem !important;
        font-size: 1.2rem !important;
      }
      
      .navegacion-historial {
        padding: 0.6rem !important;
      }
      
      .fecha-historial-titulo {
        font-size: 1rem !important;
      }
      
      .fecha-historial-valor {
        font-size: 0.9rem !important;
      }

      /* Responsive para modales */
      #modalHistorial,
      #modalA√±adirStock,
      #modalCorreccionStock {
        padding: 1rem;
        padding-top: 1rem !important;
        padding-bottom: 2rem !important;
      }
      
      #modalHistorial .modal-content,
      #modalA√±adirStock .modal-content,
      #modalCorreccionStock .modal-content {
        width: 100%;
        max-height: calc(100vh - 6rem) !important;
        min-height: 250px !important;
      }
      
      #modalHistorial .modal-content h4,
      #modalA√±adirStock .modal-content h4,
      #modalCorreccionStock .modal-content h4 {
        padding: 1rem;
        font-size: 1.1rem;
      }
      
      #modalHistorial .modal-body,
      #modalA√±adirStock .modal-body,
      #modalCorreccionStock .modal-body {
        padding: 0.8rem;
        max-height: calc(100vh - 280px);
      }

      #modalHistorial #listaHistorial {
        max-height: calc(100vh - 380px);
      }

      .fecha-stock-input {
        max-width: 100%;
      }

      /* Responsive para nuevo formato de historial inventario */
      .movimiento-hora {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .movimiento-item {
        padding: 0.3rem 0.8rem !important;
        gap: 0.8rem !important;
        grid-template-columns: 1fr 50px 50px !important;
      }
      
      .item-cantidad-inventario,
      .item-stock-inventario {
        width: 50px !important;
        font-size: 0.9rem !important;
      }
      
      .movimientos-totales {
        padding: 0.5rem 0.8rem;
      }
      
      .total-fila-inventario {
        gap: 0.8rem !important;
        grid-template-columns: 1fr 50px 50px !important;
      }
      
      .total-valor-inventario {
        width: 50px !important;
        font-size: 0.9rem !important;
      }
      
      .total-etiqueta-inventario {
        font-size: 0.9rem !important;
      }
      
      .input-cantidad-stock {
        width: 55px;
        padding: 0.2rem 0.2rem !important;
        font-size: 0.9rem;
        height: 1.6rem !important;
      }

      .btn-eliminar-sabor-stock {
        width: 22px !important;
        height: 22px !important;
        padding: 0.05rem !important;
        font-size: 0.8rem !important;
      }

      .col-eliminar-stock {
        width: 35px;
      }

      .col-cantidad-stock {
        width: 70px;
      }

      .tabla-stock td {
        padding: 0.25rem 0.2rem;
        height: 2rem;
      }

      /* Responsive para modal correcci√≥n */
      .radio-group {
        gap: 0.4rem;
      }
      
      .radio-option {
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventario</h1>
  </header>

  <main class="container">
    <div class="botones-superiores">
      <button class="btn-volver" onclick="window.location.href='index.html'">‚Üê Atr√°s</button>
      <button class="btn-borrar" onclick="mostrarHistorial()">üìä Historial</button>
      <button class="btn-borrar" onclick="abrirModalA√±adirStock()" style="background-color: #28a745;">üì¶ A√±adir Stock</button>
    </div>

    <div class="lista-sabores">
      <h3>Stock de sabores disponibles:</h3>
      <div class="tabla-sabores">
        <div class="tabla-header inventario" style="display: grid; grid-template-columns: 1fr 60px 60px; background-color: #4ecdc4; color: white; font-weight: bold; padding: 0.8rem 0;">
          <div style="padding: 0 0.8rem; display: flex; align-items: center; cursor: pointer;" onclick="ordenarPorSabor()">Sabor ‚ÜïÔ∏è</div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="ordenarPorStock()">Stock <span id="indicadorOrden">‚ÜïÔ∏è</span></div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center;"></div>
        </div>
        <div id="tablaInventario" class="tabla-body"></div>
      </div>

      <!-- Bot√≥n de borrar inventario despu√©s de la tabla -->
      <div style="display: flex; justify-content: center; margin-top: 2rem;">
        <button type="button" onclick="confirmarBorradoInventario()" style="padding: 0.8rem 2rem; font-size: 1rem; border: none; border-radius: 5px; background-color: #dc3545; color: white; cursor: pointer; transition: background-color 0.3s ease;">
          üóë Borrar inventario completo
        </button>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal oculto">
      <div class="modal-content">
        <h4>Confirmar operaci√≥n</h4>
        <div class="modal-body">
          <p id="mensajeConfirmacion"></p>
          <div class="modal-botones">
            <button class="btn-cancelar" onclick="cancelarOperacion()">Cancelar</button>
            <button class="btn-confirmar" onclick="ejecutarOperacion()">Continuar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal correcci√≥n de stock -->
    <div id="modalCorreccionStock" class="modal oculto">
      <div class="modal-content">
        <h4 id="tituloCorreccionStock">üîß Correcci√≥n de Stock</h4>
        <div class="modal-body">
          <!-- Stock actual -->
          <div class="stock-actual-info">
            <p class="stock-actual-contenido">Stock actual: <span id="stockActualValor" class="stock-actual-numero">0</span></p>
          </div>

          <!-- Tipo de correcci√≥n -->
          <div class="tipo-correccion">
            <label>üîß Tipo de correcci√≥n:</label>
            <div class="radio-group">
              <div class="radio-option" onclick="seleccionarTipoCorreccion('agregar')">
                <label for="radioAgregar">‚ûï Agregar al stock actual</label>
                <input type="radio" name="tipoCorreccion" value="agregar" id="radioAgregar">
              </div>
              <div class="radio-option" onclick="seleccionarTipoCorreccion('reducir')">
                <label for="radioReducir">‚ûñ Reducir del stock actual</label>
                <input type="radio" name="tipoCorreccion" value="reducir" id="radioReducir">
              </div>
              <div class="radio-option" onclick="seleccionarTipoCorreccion('establecer')">
                <label for="radioEstablecer">üéØ Establecer stock exacto</label>
                <input type="radio" name="tipoCorreccion" value="establecer" id="radioEstablecer">
              </div>
            </div>
          </div>

          <!-- Cantidad -->
          <div class="cantidad-correccion">
            <div class="cantidad-fila">
              <label id="labelCantidad">üìù Cantidad:</label>
              <input type="number" id="inputCantidadCorreccion" class="input-cantidad-correccion" min="0" max="999" inputmode="numeric" placeholder="0" oninput="calcularResultado()">
            </div>
          </div>

          <!-- Preview del resultado -->
          <div id="resultadoPreview" class="resultado-preview">
            <p class="resultado-contenido">Resultado: <span id="resultadoStockNuevo" class="resultado-numero">0</span></p>
          </div>

          <!-- Motivo de la correcci√≥n -->
          <div class="motivo-correccion">
            <label>üìã Motivo de la correcci√≥n:</label>
            <select id="selectMotivo" class="select-motivo" onchange="manejarCambioMotivo()">
              <option value="">Seleccionar motivo...</option>
              <option value="error_conteo">Error de conteo</option>
              <option value="merma_dano">Merma/Da√±o</option>
              <option value="stock_perdido">Stock perdido</option>
              <option value="conteo_fisico">Conteo f√≠sico</option>
              <option value="otro">Otro...</option>
            </select>
            <input type="text" id="inputMotivoOtro" class="input-motivo-otro" placeholder="Especificar motivo..." maxlength="100">
          </div>

          <!-- Botones del modal -->
          <div class="modal-botones" style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
            <button class="btn-cancelar" onclick="cerrarModalCorreccion()">Cancelar</button>
            <button class="btn-confirmar" onclick="procesarCorreccion()">‚úÖ Aplicar Correcci√≥n</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal historial -->
    <div id="modalHistorial" class="modal oculto">
      <div class="modal-content modal-grande">
        <h4>Historial de movimientos</h4>
        <div class="modal-body">
          <!-- Navegaci√≥n por d√≠as con estructura mejorada -->
          <div class="navegacion-historial">
            <button id="btnDiaAnterior" class="btn-navegacion-historial">‚Üê</button>
            <div class="fecha-historial-info">
              <div class="fecha-historial-titulo">Movimientos del</div>
              <div id="fechaActualHistorial" class="fecha-historial-valor"></div>
            </div>
            <button id="btnDiaSiguiente" class="btn-navegacion-historial">‚Üí</button>
          </div>
          
          <div id="listaHistorial"></div>
          <div class="modal-botones">
            <button class="btn-confirmar" onclick="cerrarHistorial()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para a√±adir stock -->
    <div id="modalA√±adirStock" class="modal oculto">
      <div class="modal-content">
        <h4>üì¶ A√±adir Stock</h4>
        <div class="modal-body">
          <!-- Selector de fecha -->
          <div class="fecha-stock-selector">
            <label for="fechaStock">üìÖ Fecha del movimiento:</label>
            <input type="date" id="fechaStock" class="fecha-stock-input" />
          </div>

          <!-- Bot√≥n para seleccionar sabores -->
          <button type="button" class="btn-seleccionar-sabores" onclick="abrirSelectorSabores()">
            üç¶ Seleccionar sabores
          </button>

          <!-- Aqu√≠ se cargar√°n los sabores seleccionados (AHORA EN FASE 2) -->
          <div id="saboresSeleccionados">
            <p class="mensaje-sin-sabores">
              No hay sabores seleccionados
            </p>
          </div>

          <!-- Botones del modal -->
          <div class="modal-botones" style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
            <button class="btn-cancelar" onclick="cerrarModalA√±adirStock()">Cancelar</button>
            <button class="btn-confirmar" onclick="procesarStock()">‚úÖ Guardar Stock</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal selector de sabores -->
    <div id="modalSelectorSabores" class="modal oculto">
      <div class="modal-content">
        <h4>üç¶ Seleccionar Sabores</h4>
        <div class="lista-sabores-selector" id="listaSaboresSelector">
          <!-- Aqu√≠ se cargar√°n los sabores disponibles -->
        </div>
        <div class="modal-botones" style="padding: 1rem; border-top: 1px solid #eee;">
          <button class="btn-cancelar" onclick="cerrarSelectorSabores()">Cancelar</button>
          <button class="btn-confirmar" onclick="confirmarSaboresSeleccionados()">‚úÖ Continuar</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let saborActual = null;
    let cantidadPendiente = 0;
    let ordenActual = 'alfabetico';
    let fechaHistorialActual = null;
    let diasConMovimientos = [];
    let saboresSeleccionadosStock = [];
    let datosCorreccionActual = null;
    const tablaInventario = document.getElementById("tablaInventario");

    function cargarSabores() {
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      const saboresDisponibles = sabores.filter(sabor => sabor.disponible === true);
      
      tablaInventario.innerHTML = "";
      
      if (saboresDisponibles.length === 0) {
        tablaInventario.innerHTML = '<div class="no-sabores">No hay sabores disponibles para inventario.<br>Marca algunos sabores como "disponibles" en la secci√≥n Sabores.</div>';
        return;
      }
      
      let saboresConStock = saboresDisponibles.map(sabor => ({
        ...sabor,
        stock: inventario[sabor.id] ? inventario[sabor.id].stock : 0
      }));
      
      switch(ordenActual) {
        case 'alfabetico':
          saboresConStock.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
          document.getElementById('indicadorOrden').textContent = '‚ÜïÔ∏è';
          break;
        case 'stock-asc':
          saboresConStock.sort((a, b) => a.stock - b.stock);
          document.getElementById('indicadorOrden').textContent = '‚Üë';
          break;
        case 'stock-desc':
          saboresConStock.sort((a, b) => b.stock - a.stock);
          document.getElementById('indicadorOrden').textContent = '‚Üì';
          break;
      }
      
      saboresConStock.forEach(sabor => {
        const fila = document.createElement("div");
        fila.className = "tabla-fila inventario";
        fila.style.display = "grid";
        fila.style.gridTemplateColumns = "1fr 60px 60px";
        fila.style.padding = "0.8rem 0";
        fila.style.borderBottom = "1px solid #eee";
        fila.innerHTML = `
          <div style="padding: 0 0.8rem; display: flex; align-items: center;">${sabor.nombre}</div>
          <div class="col-stock" style="padding: 0 0.8rem;">${sabor.stock}</div>
          <div class="col-accion" style="padding: 0 0.8rem;">
            <button class="btn-editar" onclick="abrirModalCorreccion('${sabor.id}', '${sabor.nombre}', ${sabor.stock})">üîß</button>
          </div>
        `;
        tablaInventario.appendChild(fila);
      });
    }

    function ordenarPorSabor() {
      ordenActual = 'alfabetico';
      cargarSabores();
    }

    function ordenarPorStock() {
      if (ordenActual === 'alfabetico' || ordenActual === 'stock-desc') {
        ordenActual = 'stock-asc';
      } else if (ordenActual === 'stock-asc') {
        ordenActual = 'stock-desc';
      }
      cargarSabores();
    }

    // ===== FUNCIONES PARA CORRECCI√ìN DE STOCK =====
    function abrirModalCorreccion(saborId, saborNombre, stockActual) {
      datosCorreccionActual = {
        id: saborId,
        nombre: saborNombre,
        stockActual: stockActual
      };

      // Configurar modal - T√çTULO EN DOS L√çNEAS
      document.getElementById("tituloCorreccionStock").innerHTML = `
        üîß Correcci√≥n de Stock<br>
        <span style="font-size: 1rem; font-weight: normal; color: #666;">${saborNombre}</span>
      `;
      
      document.getElementById("stockActualValor").textContent = stockActual;

      // Limpiar formulario
      limpiarFormularioCorreccion();

      // Mostrar modal
      document.getElementById("modalCorreccionStock").classList.remove("oculto");
    }

    function cerrarModalCorreccion() {
      document.getElementById("modalCorreccionStock").classList.add("oculto");
      datosCorreccionActual = null;
      limpiarFormularioCorreccion();
    }

    function limpiarFormularioCorreccion() {
      // Limpiar radio buttons
      document.querySelectorAll('input[name="tipoCorreccion"]').forEach(radio => {
        radio.checked = false;
      });
      document.querySelectorAll('.radio-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Limpiar inputs
      document.getElementById("inputCantidadCorreccion").value = "";
      document.getElementById("selectMotivo").value = "";
      document.getElementById("inputMotivoOtro").value = "";
      document.getElementById("inputMotivoOtro").classList.remove("visible");

      // Ocultar preview
      document.getElementById("resultadoPreview").classList.remove("visible");

      // Resetear label
      document.getElementById("labelCantidad").textContent = "üìù Cantidad:";
    }

    function seleccionarTipoCorreccion(tipo) {
      // Limpiar selecciones anteriores
      document.querySelectorAll('.radio-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Marcar opci√≥n seleccionada
      const radioOption = document.querySelector(`#radio${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).parentNode;
      radioOption.classList.add('selected');
      document.querySelector(`#radio${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).checked = true;

      // Actualizar label seg√∫n el tipo
      const labelCantidad = document.getElementById("labelCantidad");
      switch(tipo) {
        case 'agregar':
          labelCantidad.textContent = "‚ûï Cantidad a agregar:";
          break;
        case 'reducir':
          labelCantidad.textContent = "‚ûñ Cantidad a reducir:";
          break;
        case 'establecer':
          labelCantidad.textContent = "üéØ Stock exacto a establecer:";
          break;
      }

      // Recalcular resultado si hay cantidad
      calcularResultado();
    }

    function calcularResultado() {
      const tipoSeleccionado = document.querySelector('input[name="tipoCorreccion"]:checked');
      const cantidad = parseInt(document.getElementById("inputCantidadCorreccion").value) || 0;
      const preview = document.getElementById("resultadoPreview");
      const stockNuevo = document.getElementById("resultadoStockNuevo");

      if (!tipoSeleccionado || cantidad === 0) {
        preview.classList.remove("visible");
        return;
      }

      let resultado = 0;
      const stockActual = datosCorreccionActual.stockActual;

      switch(tipoSeleccionado.value) {
        case 'agregar':
          resultado = stockActual + cantidad;
          break;
        case 'reducir':
          resultado = Math.max(0, stockActual - cantidad);
          break;
        case 'establecer':
          resultado = cantidad;
          break;
      }

      stockNuevo.textContent = resultado;
      preview.classList.add("visible");

      // Validar que el resultado sea v√°lido
      if (resultado < 0) {
        stockNuevo.style.color = '#dc3545';
        preview.style.borderColor = '#dc3545';
        preview.style.backgroundColor = '#f8d7da';
      } else {
        stockNuevo.style.color = '#2c7a73';
        preview.style.borderColor = '#4ecdc4';
        preview.style.backgroundColor = '#e8f5f4';
      }
    }

    function manejarCambioMotivo() {
      const selectMotivo = document.getElementById("selectMotivo");
      const inputOtro = document.getElementById("inputMotivoOtro");

      if (selectMotivo.value === "otro") {
        inputOtro.classList.add("visible");
        inputOtro.focus();
      } else {
        inputOtro.classList.remove("visible");
        inputOtro.value = "";
      }
    }

    function procesarCorreccion() {
      const tipoSeleccionado = document.querySelector('input[name="tipoCorreccion"]:checked');
      const cantidad = parseInt(document.getElementById("inputCantidadCorreccion").value) || 0;
      const motivoSelect = document.getElementById("selectMotivo").value;
      const motivoOtro = document.getElementById("inputMotivoOtro").value.trim();

      // Validaciones
      if (!tipoSeleccionado) {
        alert("Selecciona un tipo de correcci√≥n");
        return;
      }

      if (cantidad <= 0) {
        alert("Ingresa una cantidad v√°lida mayor a 0");
        return;
      }

      if (!motivoSelect) {
        alert("Selecciona un motivo para la correcci√≥n");
        return;
      }

      if (motivoSelect === "otro" && !motivoOtro) {
        alert("Especifica el motivo de la correcci√≥n");
        return;
      }

      // Calcular resultado final
      const stockActual = datosCorreccionActual.stockActual;
      let stockNuevo = 0;
      let diferencia = 0;

      switch(tipoSeleccionado.value) {
        case 'agregar':
          stockNuevo = stockActual + cantidad;
          diferencia = cantidad;
          break;
        case 'reducir':
          stockNuevo = Math.max(0, stockActual - cantidad);
          diferencia = -(stockActual - stockNuevo);
          break;
        case 'establecer':
          stockNuevo = cantidad;
          diferencia = stockNuevo - stockActual;
          break;
      }

      if (stockNuevo < 0) {
        alert("El resultado no puede ser negativo");
        return;
      }

      // Preparar datos para confirmaci√≥n
      const motivo = motivoSelect === "otro" ? motivoOtro : obtenerTextoMotivo(motivoSelect);
      const tipoTexto = obtenerTextoTipo(tipoSeleccionado.value);

      let mensaje = `Confirmar correcci√≥n de stock:\n\n`;
      mensaje += `üç¶ Sabor: ${datosCorreccionActual.nombre}\n`;
      mensaje += `üîß Tipo: ${tipoTexto}\n`;
      mensaje += `üìù Cantidad: ${cantidad}\n`;
      mensaje += `üìã Motivo: ${motivo}\n\n`;
      mensaje += `üìä Resultado:\n`;
      mensaje += `‚Ä¢ Stock actual: ${stockActual}\n`;
      mensaje += `‚Ä¢ Stock nuevo: ${stockNuevo}\n`;
      mensaje += `‚Ä¢ Diferencia: ${diferencia >= 0 ? '+' : ''}${diferencia}\n\n`;
      mensaje += `¬øConfirmar correcci√≥n?`;

      if (confirm(mensaje)) {
        ejecutarCorreccion(tipoSeleccionado.value, cantidad, stockNuevo, diferencia, motivo);
      }
    }

    function obtenerTextoMotivo(valor) {
      const motivos = {
        'error_conteo': 'Error de conteo',
        'merma_dano': 'Merma/Da√±o',
        'stock_perdido': 'Stock perdido',
        'conteo_fisico': 'Conteo f√≠sico'
      };
      return motivos[valor] || valor;
    }

    function obtenerTextoTipo(valor) {
      const tipos = {
        'agregar': 'Agregar al stock',
        'reducir': 'Reducir del stock',
        'establecer': 'Establecer stock exacto'
      };
      return tipos[valor] || valor;
    }

    function ejecutarCorreccion(tipo, cantidad, stockNuevo, diferencia, motivo) {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const fechaHora = obtenerFechaHoraLocal();

      // Inicializar inventario si no existe
      if (!inventario[datosCorreccionActual.id]) {
        inventario[datosCorreccionActual.id] = {
          sabor: datosCorreccionActual.nombre,
          stock: 0,
          historial: []
        };
      }

      // Actualizar stock
      inventario[datosCorreccionActual.id].stock = stockNuevo;

      // Agregar al historial
      inventario[datosCorreccionActual.id].historial.push({
        fecha: fechaHora.fecha,
        hora: fechaHora.hora,
        cantidad: diferencia,
        tipo: "correccion",
        stockResultante: stockNuevo,
        motivo: motivo,
        tipoCorreccion: tipo,
        cantidadOriginal: cantidad
      });

      // Guardar cambios
      localStorage.setItem("inventario_hielitos", JSON.stringify(inventario));

      // Cerrar modal y actualizar vista
      cerrarModalCorreccion();
      cargarSabores();

      // Mostrar confirmaci√≥n
      let mensajeExito = `‚úÖ Correcci√≥n aplicada correctamente!\n\n`;
      mensajeExito += `üç¶ ${datosCorreccionActual.nombre}\n`;
      mensajeExito += `üìä Stock: ${datosCorreccionActual.stockActual} ‚Üí ${stockNuevo}\n`;
      mensajeExito += `üìã Motivo: ${motivo}`;

      alert(mensajeExito);
    }

    function cancelarOperacion() {
      document.getElementById("modalConfirmacion").classList.add("oculto");
    }

    // Esta funci√≥n ya no se usa - eliminada para evitar conflictos

    function mostrarHistorial() {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      let historialCompleto = [];
      Object.values(inventario).forEach(item => {
        item.historial.forEach(mov => {
          historialCompleto.push({
            sabor: item.sabor,
            ...mov
          });
        });
      });
      
      if (historialCompleto.length === 0) {
        document.getElementById("listaHistorial").innerHTML = '<p class="no-sabores">No hay movimientos registrados</p>';
        document.getElementById("modalHistorial").classList.remove("oculto");
        
        setTimeout(() => {
          const modal = document.getElementById("modalHistorial");
          const modalContent = modal.querySelector(".modal-content");
          modalContent.scrollTop = 0;
        }, 100);
        
        return;
      }
      
      diasConMovimientos = [...new Set(historialCompleto.map(mov => mov.fecha))];
      diasConMovimientos.sort((a, b) => new Date(b) - new Date(a));
      
      if (!fechaHistorialActual || !diasConMovimientos.includes(fechaHistorialActual)) {
        fechaHistorialActual = diasConMovimientos[0];
      }
      
      cargarMovimientosDia(fechaHistorialActual);
      document.getElementById("modalHistorial").classList.remove("oculto");
      
      setTimeout(() => {
        const modal = document.getElementById("modalHistorial");
        const modalContent = modal.querySelector(".modal-content");
        modalContent.scrollTop = 0;
      }, 100);
    }

    function cargarMovimientosDia(fecha) {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const listaHistorial = document.getElementById("listaHistorial");
      
      let movimientosDelDia = [];
      Object.values(inventario).forEach(item => {
        if (item.historial) {
          item.historial.forEach(mov => {
            if (mov && mov.fecha === fecha) {
              movimientosDelDia.push({
                sabor: item.sabor,
                fecha: mov.fecha,
                hora: mov.hora || '00:00',
                cantidad: mov.cantidad,
                tipo: mov.tipo || 'entrada',
                stockResultante: mov.stockResultante,
                motivo: mov.motivo || '',
                tipoCorreccion: mov.tipoCorreccion || '',
                cantidadOriginal: mov.cantidadOriginal || 0
              });
            }
          });
        }
      });
      
      movimientosDelDia.sort((a, b) => {
        const horaA = a.hora || '00:00';
        const horaB = b.hora || '00:00';
        return horaB.localeCompare(horaA);
      });
      
      const fechaFormateada = fecha.split('-').reverse().join('/');
      document.getElementById("fechaActualHistorial").textContent = fechaFormateada;
      
      // CONFIGURAR EVENTOS DE BOTONES Y ACTUALIZAR ESTADO
      const indiceFechaActual = diasConMovimientos.indexOf(fecha);
      const btnAnterior = document.getElementById("btnDiaAnterior");
      const btnSiguiente = document.getElementById("btnDiaSiguiente");
      
      btnAnterior.onclick = null;
      btnSiguiente.onclick = null;
      
      const puedeIrAnterior = indiceFechaActual < diasConMovimientos.length - 1;
      const puedeIrSiguiente = indiceFechaActual > 0;
      
      if (puedeIrAnterior) {
        btnAnterior.disabled = false;
        btnAnterior.onclick = () => cambiarDia(1);
        btnAnterior.style.backgroundColor = "#4ecdc4";
        btnAnterior.style.opacity = "1";
        btnAnterior.style.cursor = "pointer";
      } else {
        btnAnterior.disabled = true;
        btnAnterior.onclick = null;
        btnAnterior.style.backgroundColor = "#6c757d";
        btnAnterior.style.opacity = "0.6";
        btnAnterior.style.cursor = "not-allowed";
      }
      
      if (puedeIrSiguiente) {
        btnSiguiente.disabled = false;
        btnSiguiente.onclick = () => cambiarDia(-1);
        btnSiguiente.style.backgroundColor = "#4ecdc4";
        btnSiguiente.style.opacity = "1";
        btnSiguiente.style.cursor = "pointer";
      } else {
        btnSiguiente.disabled = true;
        btnSiguiente.onclick = null;
        btnSiguiente.style.backgroundColor = "#6c757d";
        btnSiguiente.style.opacity = "0.6";
        btnSiguiente.style.cursor = "not-allowed";
      }
      
      // MOSTRAR CONTENIDO CON LAS MODIFICACIONES APLICADAS
      if (movimientosDelDia.length === 0) {
        listaHistorial.innerHTML = '<p class="no-sabores">No hay movimientos en esta fecha</p>';
      } else {
        // Agrupar movimientos por TIPO primero, luego por hora
        const movimientosPorTipo = {
          entrada: {},
          venta: {},
          correccion: {}
        };
        
        movimientosDelDia.forEach(mov => {
          const tipo = mov.tipo || 'entrada';
          const hora = mov.hora || '00:00';
          
          if (!movimientosPorTipo[tipo][hora]) {
            movimientosPorTipo[tipo][hora] = [];
          }
          movimientosPorTipo[tipo][hora].push(mov);
        });
        
        // Obtener todas las horas de todos los tipos y ordenarlas
        const todasLasHoras = new Set([
          ...Object.keys(movimientosPorTipo.entrada),
          ...Object.keys(movimientosPorTipo.venta),
          ...Object.keys(movimientosPorTipo.correccion)
        ]);
        const horasOrdenadas = Array.from(todasLasHoras).sort((a, b) => b.localeCompare(a));
        
        listaHistorial.innerHTML = horasOrdenadas.map(hora => {
          let htmlCompleto = '';
          
          // SECCI√ìN DE ENTRADAS DE STOCK (si las hay en esta hora)
          if (movimientosPorTipo.entrada[hora] && movimientosPorTipo.entrada[hora].length > 0) {
            const entradasHora = movimientosPorTipo.entrada[hora];
            
            const itemsEntradasHTML = entradasHora
              .filter(mov => {
                return mov && 
                       mov.sabor && 
                       mov.sabor.trim() !== '' &&
                       mov.cantidad !== null && 
                       mov.cantidad !== undefined &&
                       mov.cantidad !== '';
              })
              .map(mov => {
                return `
                  <div class="movimiento-item">
                    <div class="item-sabor-inventario">${mov.sabor}</div>
                    <div class="item-cantidad-inventario item-cantidad-entrada">+${Math.abs(mov.cantidad)}</div>
                    <div class="item-stock-inventario">${mov.stockResultante}</div>
                  </div>
                `;
              }).join('');
            
            const totalEntradas = entradasHora.reduce((sum, mov) => sum + Math.abs(mov.cantidad), 0);
            
            htmlCompleto += `
              <div class="movimiento-card">
                <div class="movimiento-hora" style="background-color: #e8f5f4; border-bottom: 2px solid #4ecdc4;">
                  üì¶ ${hora} - Entradas de Stock
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-items">
                  ${itemsEntradasHTML}
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-totales" style="background-color: #e8f5f4;">
                  <div class="total-fila-inventario">
                    <div class="total-etiqueta-inventario">Total agregado:</div>
                    <div class="total-valor-inventario total-valor-entradas">${totalEntradas}</div>
                    <div class="total-columna-vacia"></div>
                  </div>
                </div>
              </div>
            `;
          }
          
          // SECCI√ìN DE VENTAS (si las hay en esta hora)
          if (movimientosPorTipo.venta[hora] && movimientosPorTipo.venta[hora].length > 0) {
            const ventasHora = movimientosPorTipo.venta[hora];
            
            const itemsVentasHTML = ventasHora
              .filter(mov => {
                return mov && 
                       mov.sabor && 
                       mov.sabor.trim() !== '' &&
                       mov.cantidad !== null && 
                       mov.cantidad !== undefined &&
                       mov.cantidad !== '';
              })
              .map(mov => {
                return `
                  <div class="movimiento-item">
                    <div class="item-sabor-inventario">${mov.sabor}</div>
                    <div class="item-cantidad-inventario item-cantidad-venta">${Math.abs(mov.cantidad)}</div>
                    <div class="item-stock-inventario">${mov.stockResultante}</div>
                  </div>
                `;
              }).join('');
            
            const totalVentas = ventasHora.reduce((sum, mov) => sum + Math.abs(mov.cantidad), 0);
            
            htmlCompleto += `
              <div class="movimiento-card">
                <div class="movimiento-hora" style="background-color: #fdeaea; border-bottom: 2px solid #dc3545;">
                  üõí ${hora} - Ventas
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-items">
                  ${itemsVentasHTML}
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-totales" style="background-color: #fdeaea;">
                  <div class="total-fila-inventario">
                    <div class="total-etiqueta-inventario">Total vendido:</div>
                    <div class="total-valor-inventario total-valor-ventas">${totalVentas}</div>
                    <div class="total-columna-vacia"></div>
                  </div>
                </div>
              </div>
            `;
          }

          // SECCI√ìN DE CORRECCIONES (si las hay en esta hora)
          if (movimientosPorTipo.correccion[hora] && movimientosPorTipo.correccion[hora].length > 0) {
            const correccionesHora = movimientosPorTipo.correccion[hora];
            
            const itemsCorreccionesHTML = correccionesHora
              .filter(mov => {
                return mov && 
                       mov.sabor && 
                       mov.sabor.trim() !== '' &&
                       mov.cantidad !== null && 
                       mov.cantidad !== undefined &&
                       mov.cantidad !== '';
              })
              .map(mov => {
                const signo = mov.cantidad >= 0 ? '+' : '';
                return `
                  <div class="movimiento-item">
                    <div class="item-sabor-inventario">${mov.sabor}${mov.motivo ? ` (${mov.motivo})` : ''}</div>
                    <div class="item-cantidad-inventario item-cantidad-correccion">${signo}${mov.cantidad}</div>
                    <div class="item-stock-inventario">${mov.stockResultante}</div>
                  </div>
                `;
              }).join('');
            
            const totalCorrecciones = correccionesHora.reduce((sum, mov) => sum + mov.cantidad, 0);
            const signoTotal = totalCorrecciones >= 0 ? '+' : '';
            
            htmlCompleto += `
              <div class="movimiento-card">
                <div class="movimiento-hora" style="background-color: #fef9e6; border-bottom: 2px solid #ffc107;">
                  üîß ${hora} - Correcciones de Stock
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-items">
                  ${itemsCorreccionesHTML}
                </div>
                <div class="separador-inventario"></div>
                <div class="movimientos-totales" style="background-color: #fef9e6;">
                  <div class="total-fila-inventario">
                    <div class="total-etiqueta-inventario">Total corregido:</div>
                    <div class="total-valor-inventario total-valor-correcciones">${signoTotal}${totalCorrecciones}</div>
                    <div class="total-columna-vacia"></div>
                  </div>
                </div>
              </div>
            `;
          }
          
          return htmlCompleto;
        }).join('');
      }
    }

    function cambiarDia(direccion) {
      const indiceActual = diasConMovimientos.indexOf(fechaHistorialActual);
      const nuevoIndice = indiceActual + direccion;
      
      if (nuevoIndice >= 0 && nuevoIndice < diasConMovimientos.length) {
        fechaHistorialActual = diasConMovimientos[nuevoIndice];
        cargarMovimientosDia(fechaHistorialActual);
      }
    }

    function cerrarHistorial() {
      document.getElementById("modalHistorial").classList.add("oculto");
      fechaHistorialActual = null;
    }

    // ===== FUNCIONES PARA A√ëADIR STOCK MASIVO =====
    function abrirModalA√±adirStock() {
      const fechaInput = document.getElementById("fechaStock");
      const fechaHoy = obtenerFechaLocal();
      fechaInput.value = fechaHoy;
      fechaInput.max = fechaHoy;
      
      saboresSeleccionadosStock = [];
      actualizarVistaSaboresSeleccionados();
      
      document.getElementById("modalA√±adirStock").classList.remove("oculto");
    }

    function cerrarModalA√±adirStock() {
      document.getElementById("modalA√±adirStock").classList.add("oculto");
      saboresSeleccionadosStock = [];
    }

    function abrirSelectorSabores() {
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      const saboresDisponibles = sabores.filter(sabor => 
        sabor.disponible && 
        !saboresSeleccionadosStock.some(seleccionado => seleccionado.id === sabor.id)
      );
      
      const listaSaboresSelector = document.getElementById("listaSaboresSelector");
      
      if (saboresDisponibles.length === 0) {
        listaSaboresSelector.innerHTML = `
          <p style="text-align: center; color: #666; padding: 2rem; font-style: italic;">
            ${saboresSeleccionadosStock.length > 0 ? 
              'Todos los sabores disponibles ya han sido seleccionados' : 
              'No hay sabores disponibles para agregar stock'
            }
          </p>
        `;
      } else {
        saboresDisponibles.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
        
        listaSaboresSelector.innerHTML = saboresDisponibles.map(sabor => `
          <div class="sabor-item-selector">
            <input type="checkbox" class="sabor-checkbox" id="sabor_${sabor.id}" data-sabor-id="${sabor.id}" />
            <label for="sabor_${sabor.id}" class="sabor-nombre">${sabor.nombre}</label>
          </div>
        `).join('');
      }
      
      document.getElementById("modalSelectorSabores").classList.remove("oculto");
    }

    function cerrarSelectorSabores() {
      document.getElementById("modalSelectorSabores").classList.add("oculto");
    }

    function confirmarSaboresSeleccionados() {
      const checkboxes = document.querySelectorAll('.sabor-checkbox:checked');
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      
      checkboxes.forEach(checkbox => {
        const saborId = checkbox.dataset.saborId;
        const sabor = sabores.find(s => s.id === saborId);
        
        if (sabor && !saboresSeleccionadosStock.some(s => s.id === saborId)) {
          saboresSeleccionadosStock.push({
            id: sabor.id,
            nombre: sabor.nombre,
            cantidad: 0
          });
        }
      });
      
      cerrarSelectorSabores();
      actualizarVistaSaboresSeleccionados();
    }

    function actualizarVistaSaboresSeleccionados() {
      const contenedor = document.getElementById("saboresSeleccionados");
      
      if (saboresSeleccionadosStock.length === 0) {
        contenedor.innerHTML = `
          <p class="mensaje-sin-sabores">
            No hay sabores seleccionados
          </p>
        `;
        return;
      }
      
      saboresSeleccionadosStock.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
      
      contenedor.innerHTML = `
        <div class="formulario-sabores-stock">
          <h5>üìù Cantidades a agregar:</h5>
          <table class="tabla-stock">
            ${saboresSeleccionadosStock.map(sabor => `
              <tr>
                <td class="col-eliminar-stock">
                  <button onclick="eliminarSaborSeleccionado('${sabor.id}')" 
                          class="btn-eliminar-sabor-stock"
                          onmouseover="this.style.background='#dc3545'; this.style.color='white';" 
                          onmouseout="this.style.background='#f8f9fa'; this.style.color='#dc3545';">‚ùå</button>
                </td>
                <td class="col-sabor-stock">
                  <div class="sabor-stock-nombre">${sabor.nombre}</div>
                </td>
                <td class="col-cantidad-stock">
                  <input type="number" 
                         class="input-cantidad-stock" 
                         id="cantidad_${sabor.id}" 
                         min="1" 
                         max="999"
                         value="${sabor.cantidad || ''}" 
                         placeholder="0"
                         inputmode="numeric"
                         onfocus="manejarFocoInputStock(this)"
                         onblur="manejarBlurInputStock(this, '${sabor.id}')"
                         onchange="actualizarCantidadSabor('${sabor.id}', this.value)" />
                </td>
              </tr>
            `).join('')}
          </table>
        </div>
      `;
    }

    function eliminarSaborSeleccionado(saborId) {
      saboresSeleccionadosStock = saboresSeleccionadosStock.filter(sabor => sabor.id !== saborId);
      actualizarVistaSaboresSeleccionados();
    }

    function manejarFocoInputStock(input) {
      setTimeout(() => {
        input.select();
      }, 50);
      
      setTimeout(() => {
        const rect = input.getBoundingClientRect();
        const inputTop = rect.top + window.pageYOffset;
        const offset = 120;
        const scrollTo = inputTop - offset;
        
        window.scrollTo({
          top: Math.max(0, scrollTo),
          behavior: 'smooth'
        });
      }, 300);
    }

    function manejarBlurInputStock(input, saborId) {
      let valor = parseInt(input.value) || 0;
      if (valor < 0) {
        valor = 0;
        input.value = '';
      }
      
      actualizarCantidadSabor(saborId, valor);
    }

    function actualizarCantidadSabor(saborId, cantidad) {
      const sabor = saboresSeleccionadosStock.find(s => s.id === saborId);
      if (sabor) {
        sabor.cantidad = parseInt(cantidad) || 0;
      }
    }

    function obtenerHoraStock() {
      const fechaInput = document.getElementById("fechaStock");
      const fechaHoy = obtenerFechaLocal();
      const fechaSeleccionada = fechaInput.value;
      
      if (fechaSeleccionada === fechaHoy) {
        return obtenerHoraLocal();
      } else {
        return "23:00";
      }
    }

    function procesarStock() {
      if (saboresSeleccionadosStock.length === 0) {
        alert("Selecciona al menos un sabor para continuar");
        return;
      }
      
      const fecha = document.getElementById("fechaStock").value;
      if (!fecha) {
        alert("Selecciona una fecha v√°lida");
        return;
      }

      const fechaHoy = obtenerFechaLocal();
      if (fecha > fechaHoy) {
        alert("No se pueden agregar movimientos a fechas futuras");
        return;
      }

      const stockValido = saboresSeleccionadosStock.filter(sabor => {
        const cantidad = parseInt(sabor.cantidad) || 0;
        return cantidad > 0;
      });

      if (stockValido.length === 0) {
        alert("Ingresa al menos una cantidad v√°lida (mayor a 0)");
        return;
      }

      const fechaFormateada = fecha.split('-').reverse().join('/');
      const horaStock = obtenerHoraStock();
      const esRetroactiva = fecha !== fechaHoy;
      
      let mensaje = `Confirmar entrada de stock:\n\n`;
      mensaje += `üìÖ Fecha: ${fechaFormateada}\n`;
      mensaje += `üïê Hora: ${horaStock}`;
      if (esRetroactiva) {
        mensaje += ` (retroactiva)`;
      }
      mensaje += `\n\nüì¶ Stock a agregar:\n`;
      
      stockValido.forEach(sabor => {
        mensaje += `‚Ä¢ ${sabor.nombre}: +${sabor.cantidad}\n`;
      });

      const totalUnidades = stockValido.reduce((sum, sabor) => sum + sabor.cantidad, 0);
      mensaje += `\nüî¢ Total: ${totalUnidades} unidades\n\n¬øConfirmar operaci√≥n?`;

      if (confirm(mensaje)) {
        ejecutarStockMasivo(fecha, horaStock, stockValido);
      }
    }

    function ejecutarStockMasivo(fecha, hora, stockValido) {
      try {
        const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
        const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
        
        let resultados = [];

        stockValido.forEach(saborStock => {
          const sabor = sabores.find(s => s.id === saborStock.id);
          if (!sabor) return;

          if (!inventario[saborStock.id]) {
            inventario[saborStock.id] = {
              sabor: sabor.nombre,
              stock: 0,
              historial: []
            };
          }

          const stockAnterior = inventario[saborStock.id].stock;
          inventario[saborStock.id].stock += saborStock.cantidad;

          inventario[saborStock.id].historial.push({
            fecha: fecha,
            hora: hora,
            cantidad: saborStock.cantidad,
            tipo: "entrada",
            stockResultante: inventario[saborStock.id].stock
          });

          resultados.push({
            nombre: sabor.nombre,
            cantidad: saborStock.cantidad,
            stockAnterior: stockAnterior,
            stockNuevo: inventario[saborStock.id].stock
          });
        });

        localStorage.setItem("inventario_hielitos", JSON.stringify(inventario));

        saboresSeleccionadosStock = [];
        cerrarModalA√±adirStock();
        cargarSabores();

        let mensajeExito = `‚úÖ Stock actualizado correctamente!\n\n`;
        mensajeExito += `üìÖ ${fecha.split('-').reverse().join('/')} a las ${hora}\n\n`;
        mensajeExito += `üìã Resumen:\n`;
        resultados.forEach(resultado => {
          mensajeExito += `‚Ä¢ ${resultado.nombre}: ${resultado.stockAnterior} ‚Üí ${resultado.stockNuevo} (+${resultado.cantidad})\n`;
        });

        const totalProcesado = resultados.reduce((sum, r) => sum + r.cantidad, 0);
        mensajeExito += `\nüî¢ Total procesado: ${totalProcesado} unidades`;

        alert(mensajeExito);

      } catch (error) {
        console.error("Error al procesar stock masivo:", error);
        alert("‚ùå Error al procesar el stock. Int√©ntalo de nuevo.");
      }
    }

    function confirmarBorradoInventario() {
      const confirmacion = confirm(
        "‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\nEsto borrar√° TODO el inventario (stock y historial).\nLos SABORES se mantendr√°n intactos.\n\n¬øEst√°s seguro de continuar?"
      );
      if (confirmacion) {
        localStorage.removeItem("inventario_hielitos");
        alert("Inventario borrado correctamente.\nLos sabores se mantienen intactos.");
        cargarSabores();
      }
    }

    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("modal")) {
        // Solo cerrar modales que no sean de confirmaci√≥n cr√≠tica
        if (e.target.id !== "modalConfirmacion") {
          cerrarHistorial();
          cerrarModalA√±adirStock();
          cerrarSelectorSabores();
          cerrarModalCorreccion();
        }
      }
    });

    window.addEventListener("DOMContentLoaded", cargarSabores);
  </script>
  <script src="script.js"></script>
</body>
</html>