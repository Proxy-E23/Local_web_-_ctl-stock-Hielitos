<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Corregir tabla inventario - Centrado limpio con columnas optimizadas */
    .tabla-header.inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
    }

    .tabla-fila.inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important;
    }

    /* Centrado específico para columnas de stock y acción */
    .col-stock {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: bold !important;
      color: #4ecdc4 !important;
    }

    .col-accion {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* BOTONES DE NAVEGACIÓN DEL HISTORIAL - ESTILO CORREGIDO */
    .btn-navegacion-historial {
      padding: 0.7rem 1rem !important;
      background-color: #4ecdc4 !important;
      color: white !important;
      border: none !important;
      border-radius: 5px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      font-size: 1.3rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .btn-navegacion-historial:hover:not(:disabled) {
      background-color: #3da9a1 !important;
      transform: translateY(-1px) !important;
    }

    .btn-navegacion-historial:disabled {
      background-color: #6c757d !important;
      opacity: 0.6 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }

    /* Contenedor de navegación del historial */
    .navegacion-historial {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      margin-bottom: 1rem !important;
      padding: 0.8rem !important;
      background-color: #f8f9fa !important;
      border-radius: 5px !important;
    }

    .fecha-historial-info {
      text-align: center !important;
      flex-grow: 1 !important;
    }

    .fecha-historial-titulo {
      font-size: 1.1rem !important;
      font-weight: bold !important;
      color: #333 !important;
      margin-bottom: 0.2rem !important;
    }

    .fecha-historial-valor {
      font-size: 1rem !important;
      font-weight: 600 !important;
      color: #4ecdc4 !important;
    }

    /* ===== ESTILOS PARA MODAL HISTORIAL FIJO SUPERIOR ===== */
    #modalHistorial {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: flex-start !important; /* Cambio clave: flex-start */
      padding-top: 2rem !important; /* Espacio desde arriba */
      box-sizing: border-box;
    }

    #modalHistorial .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      min-height: 300px !important; /* Altura mínima */
      max-height: calc(100vh - 2rem) !important; /* Aumentado: casi toda la pantalla */
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #modalHistorial .modal-content h4 {
      margin: 0;
      padding: 1.5rem 1.5rem 1rem 1.5rem;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }

    #modalHistorial .modal-body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 240px); /* Más conservador para móviles */
    }

    #modalHistorial .navegacion-historial {
      flex-shrink: 0;
      margin-bottom: 1rem;
    }

    #modalHistorial #listaHistorial {
      flex-grow: 1;
      min-height: 100px;
      /* Altura dinámica basada en viewport con margen extra para móviles */
      max-height: calc(100vh - 320px); /* Más margen para barras de navegadores móviles */
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: white;
    }

    #modalHistorial .modal-botones {
      flex-shrink: 0;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }

    /* ===== ESTILOS PARA EL NUEVO FORMATO DE HISTORIAL DE INVENTARIO MODIFICADO ===== */
    .movimiento-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .movimiento-hora {
      background-color: #f8f9fa;
      padding: 0.6rem 1rem;
      border-bottom: 2px solid #ddd;
      text-align: left;
      font-weight: bold;
      color: #495057;
      font-size: 1rem;
    }

    .movimientos-items {
      background-color: white;
    }

    /* MODIFICACIÓN: Nuevo grid con columnas optimizadas: Sabor (resto), Hielitos (60px), Stock (60px) */
    .movimiento-item {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important; /* Sabor ocupa resto, Hielitos y Stock 60px cada uno */
      gap: 1rem !important;
      padding: 0.4rem 1rem !important;
      border-bottom: 1px solid #f0f0f0 !important;
      transition: background-color 0.2s ease !important;
    }

    .movimiento-item:hover {
      background-color: #f8f9fa;
    }

    .movimiento-item:last-child {
      border-bottom: none;
    }

    /* MODIFICACIÓN: Sabor alineado a la izquierda y centrado verticalmente */
    .item-sabor-inventario {
      text-align: left !important;
      line-height: 1.3 !important;
      color: #333 !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important; /* Centrado vertical */
    }

    /* MODIFICACIÓN: Hielitos centrado con ancho fijo para 3 dígitos */
    .item-cantidad-inventario {
      text-align: center !important;
      font-weight: bold !important;
      width: 60px !important; /* Ancho fijo para 3 dígitos */
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .item-cantidad-entrada {
      color: #4ecdc4;
    }

    .item-cantidad-venta {
      color: #dc3545;
    }

    /* MODIFICACIÓN: Stock centrado con ancho fijo para 3 dígitos */
    .item-stock-inventario {
      text-align: center !important;
      color: #666 !important;
      width: 60px !important; /* Ancho fijo para 3 dígitos */
      font-size: 0.9rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .movimientos-totales {
      background-color: #f8f9fa;
      padding: 0.6rem 1rem;
      border-top: 1px solid #ddd;
    }

    /* MODIFICACIÓN: Total con nuevo grid - etiqueta alineada a la derecha en columna sabor, valor en columna hielitos */
    .total-fila-inventario {
      display: grid !important;
      grid-template-columns: 1fr 60px 60px !important; /* Mismo grid que los items */
      gap: 1rem !important;
    }

    /* MODIFICACIÓN: Etiqueta del total alineada a la derecha en la columna de sabores */
    .total-etiqueta-inventario {
      text-align: right !important;
      color: #666 !important;
      font-weight: 500 !important;
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: flex-end !important; /* Alineado a la derecha */
    }

    /* MODIFICACIÓN: Valor del total centrado en la columna de hielitos con color dinámico según tipo de movimiento */
    .total-valor-inventario {
      text-align: center !important;
      font-weight: bold !important;
      width: 60px !important; /* Mismo ancho que hielitos */
      font-size: 0.95rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* Colores dinámicos para totales según tipo de movimiento predominante */
    .total-valor-entradas {
      color: #4ecdc4 !important; /* Verde/turquesa para entradas */
    }

    .total-valor-ventas {
      color: #dc3545 !important; /* Rojo para ventas */
    }

    .total-valor-mixto {
      color: #6f42c1 !important; /* Morado para movimientos mixtos */
    }

    /* MODIFICACIÓN: Columna vacía para completar el grid (donde estaría stock) */
    .total-columna-vacia {
      width: 60px !important;
    }

    /* Separadores visuales */
    .separador-inventario {
      height: 1px;
      background-color: #ddd;
      margin: 0;
    }

    @media (max-width: 768px) {
      .tabla-header.inventario,
      .tabla-fila.inventario {
        grid-template-columns: 1fr 50px 50px !important;
      }
      
      .btn-navegacion-historial {
        padding: 0.6rem 0.8rem !important;
        font-size: 1.2rem !important;
      }
      
      .navegacion-historial {
        padding: 0.6rem !important;
      }
      
      .fecha-historial-titulo {
        font-size: 1rem !important;
      }
      
      .fecha-historial-valor {
        font-size: 0.9rem !important;
      }

      /* Responsive para modal historial */
      #modalHistorial {
        padding: 1rem;
        padding-top: 1rem !important;
        padding-bottom: 2rem !important; /* Más espacio abajo en móvil */
      }
      
      #modalHistorial .modal-content {
        width: 100%;
        max-height: calc(100vh - 6rem) !important; /* Más conservador en móvil */
        min-height: 250px !important;
      }
      
      #modalHistorial .modal-content h4 {
        padding: 1rem;
        font-size: 1.1rem;
      }
      
      #modalHistorial .modal-body {
        padding: 0.8rem;
        max-height: calc(100vh - 280px); /* Extra espacio para barras móviles */
      }

      #modalHistorial #listaHistorial {
        max-height: calc(100vh - 380px); /* Aún más conservador en móvil */
      }

      /* Responsive para nuevo formato de historial inventario */
      .movimiento-hora {
        padding: 0.5rem 0.8rem;
        font-size: 0.9rem;
      }
      
      /* MODIFICACIÓN RESPONSIVE: Mantener grid en móvil con columnas más pequeñas */
      .movimiento-item {
        padding: 0.3rem 0.8rem !important;
        gap: 0.8rem !important;
        grid-template-columns: 1fr 50px 50px !important; /* Columnas más pequeñas en móvil */
      }
      
      /* MODIFICACIÓN RESPONSIVE: Ajustar anchos en móvil */
      .item-cantidad-inventario,
      .item-stock-inventario {
        width: 50px !important; /* Más pequeño en móvil */
        font-size: 0.9rem !important;
      }
      
      .movimientos-totales {
        padding: 0.5rem 0.8rem;
      }
      
      /* MODIFICACIÓN RESPONSIVE: Grid del total también más pequeño en móvil */
      .total-fila-inventario {
        gap: 0.8rem !important;
        grid-template-columns: 1fr 50px 50px !important;
      }
      
      .total-valor-inventario {
        width: 50px !important;
        font-size: 0.9rem !important;
      }
      
      .total-etiqueta-inventario {
        font-size: 0.9rem !important;
      }
      
      .total-columna-vacia {
        width: 50px !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventario</h1>
  </header>

  <main class="container">
    <div class="botones-superiores">
      <button class="btn-volver" onclick="window.location.href='index.html'">← Atrás</button>
      <button class="btn-borrar" onclick="mostrarHistorial()">📊 Historial</button>
    </div>

    <div class="lista-sabores">
      <h3>Stock de sabores disponibles:</h3>
      <div class="tabla-sabores">
        <div class="tabla-header inventario" style="display: grid; grid-template-columns: 1fr 60px 60px; background-color: #4ecdc4; color: white; font-weight: bold; padding: 0.8rem 0;">
          <div style="padding: 0 0.8rem; display: flex; align-items: center; cursor: pointer;" onclick="ordenarPorSabor()">Sabor ↕️</div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="ordenarPorStock()">Stock <span id="indicadorOrden">↕️</span></div>
          <div style="padding: 0 0.8rem; display: flex; align-items: center; justify-content: center;"></div>
        </div>
        <div id="tablaInventario" class="tabla-body"></div>
      </div>

      <!-- Botón de borrar inventario después de la tabla -->
      <div style="display: flex; justify-content: center; margin-top: 2rem;">
        <button type="button" onclick="confirmarBorradoInventario()" style="padding: 0.8rem 2rem; font-size: 1rem; border: none; border-radius: 5px; background-color: #dc3545; color: white; cursor: pointer; transition: background-color 0.3s ease;">
          🗑 Borrar inventario completo
        </button>
      </div>
    </div>

    <!-- Modal para editar stock -->
    <div id="modalStock" class="modal oculto">
      <div class="modal-content">
        <h4 id="modalTitulo">Agregar stock</h4>
        <div class="modal-body">
          <label for="cantidadInput">Cantidad a agregar:</label>
          <input type="number" id="cantidadInput" min="1" inputmode="numeric" />
          <div class="modal-botones">
            <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
            <button class="btn-confirmar" onclick="confirmarStock()">✅ Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación -->
    <div id="modalConfirmacion" class="modal oculto">
      <div class="modal-content">
        <h4>Confirmar operación</h4>
        <div class="modal-body">
          <p id="mensajeConfirmacion"></p>
          <div class="modal-botones">
            <button class="btn-cancelar" onclick="cancelarOperacion()">Cancelar</button>
            <button class="btn-confirmar" onclick="ejecutarOperacion()">Continuar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal historial -->
    <div id="modalHistorial" class="modal oculto">
      <div class="modal-content modal-grande">
        <h4>Historial de movimientos</h4>
        <div class="modal-body">
          <!-- Navegación por días con estructura mejorada -->
          <div class="navegacion-historial">
            <button id="btnDiaAnterior" class="btn-navegacion-historial">←</button>
            <div class="fecha-historial-info">
              <div class="fecha-historial-titulo">Movimientos del</div>
              <div id="fechaActualHistorial" class="fecha-historial-valor"></div>
            </div>
            <button id="btnDiaSiguiente" class="btn-navegacion-historial">→</button>
          </div>
          
          <div id="listaHistorial"></div>
          <div class="modal-botones">
            <button class="btn-confirmar" onclick="cerrarHistorial()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let saborActual = null;
    let cantidadPendiente = 0;
    let ordenActual = 'alfabetico';
    let fechaHistorialActual = null;
    let diasConMovimientos = [];
    const tablaInventario = document.getElementById("tablaInventario");

    function cargarSabores() {
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      const saboresDisponibles = sabores.filter(sabor => sabor.disponible === true);
      
      tablaInventario.innerHTML = "";
      
      if (saboresDisponibles.length === 0) {
        tablaInventario.innerHTML = '<div class="no-sabores">No hay sabores disponibles para inventario.<br>Marca algunos sabores como "disponibles" en la sección Sabores.</div>';
        return;
      }
      
      let saboresConStock = saboresDisponibles.map(sabor => ({
        ...sabor,
        stock: inventario[sabor.id] ? inventario[sabor.id].stock : 0
      }));
      
      switch(ordenActual) {
        case 'alfabetico':
          saboresConStock.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
          document.getElementById('indicadorOrden').textContent = '↕️';
          break;
        case 'stock-asc':
          saboresConStock.sort((a, b) => a.stock - b.stock);
          document.getElementById('indicadorOrden').textContent = '↑';
          break;
        case 'stock-desc':
          saboresConStock.sort((a, b) => b.stock - a.stock);
          document.getElementById('indicadorOrden').textContent = '↓';
          break;
      }
      
      saboresConStock.forEach(sabor => {
        const fila = document.createElement("div");
        fila.className = "tabla-fila inventario";
        fila.style.display = "grid";
        fila.style.gridTemplateColumns = "1fr 60px 60px";
        fila.style.padding = "0.8rem 0";
        fila.style.borderBottom = "1px solid #eee";
        fila.innerHTML = `
          <div style="padding: 0 0.8rem; display: flex; align-items: center;">${sabor.nombre}</div>
          <div class="col-stock" style="padding: 0 0.8rem;">${sabor.stock}</div>
          <div class="col-accion" style="padding: 0 0.8rem;">
            <button class="btn-editar" onclick="editarStock('${sabor.id}', '${sabor.nombre}')">✏️</button>
          </div>
        `;
        tablaInventario.appendChild(fila);
      });
    }

    function ordenarPorSabor() {
      ordenActual = 'alfabetico';
      cargarSabores();
    }

    function ordenarPorStock() {
      if (ordenActual === 'alfabetico' || ordenActual === 'stock-desc') {
        ordenActual = 'stock-asc';
      } else if (ordenActual === 'stock-asc') {
        ordenActual = 'stock-desc';
      }
      cargarSabores();
    }

    function editarStock(saborId, saborNombre) {
      saborActual = { id: saborId, nombre: saborNombre };
      document.getElementById("modalTitulo").textContent = `Agregar stock - ${saborNombre}`;
      document.getElementById("cantidadInput").value = "";
      document.getElementById("modalStock").classList.remove("oculto");
      document.getElementById("cantidadInput").focus();
    }

    function cerrarModal() {
      document.getElementById("modalStock").classList.add("oculto");
      document.getElementById("modalConfirmacion").classList.add("oculto");
      saborActual = null;
      cantidadPendiente = 0;
    }

    function confirmarStock() {
      const cantidad = parseInt(document.getElementById("cantidadInput").value);
      
      if (!cantidad || cantidad <= 0) {
        alert("Ingrese una cantidad válida");
        return;
      }

      cantidadPendiente = cantidad;
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const stockActual = inventario[saborActual.id] ? inventario[saborActual.id].stock : 0;
      const nuevoStock = stockActual + cantidad;

      document.getElementById("mensajeConfirmacion").innerHTML = `
        Se van a anexar <strong>${cantidad}</strong> unidades a <strong>${saborActual.nombre}</strong><br>
        Resultado: <strong>${nuevoStock}</strong> en stock
      `;
      
      document.getElementById("modalStock").classList.add("oculto");
      document.getElementById("modalConfirmacion").classList.remove("oculto");
    }

    function cancelarOperacion() {
      cerrarModal();
    }

    function ejecutarOperacion() {
      if (!saborActual || !cantidadPendiente) return;

      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const fechaHora = new Date();
      const fecha = fechaHora.toISOString().split('T')[0];
      const hora = fechaHora.toTimeString().split(' ')[0].substring(0, 5);
      
      if (!inventario[saborActual.id]) {
        inventario[saborActual.id] = {
          sabor: saborActual.nombre,
          stock: 0,
          historial: []
        };
      }

      inventario[saborActual.id].stock += cantidadPendiente;
      inventario[saborActual.id].historial.push({
        fecha: fecha,
        hora: hora,
        cantidad: cantidadPendiente,
        tipo: "entrada",
        stockResultante: inventario[saborActual.id].stock
      });

      localStorage.setItem("inventario_hielitos", JSON.stringify(inventario));
      
      cerrarModal();
      cargarSabores();
      
      alert(`Stock actualizado correctamente\n${saborActual.nombre}: ${inventario[saborActual.id].stock} unidades`);
    }

    function mostrarHistorial() {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      
      let historialCompleto = [];
      Object.values(inventario).forEach(item => {
        item.historial.forEach(mov => {
          historialCompleto.push({
            sabor: item.sabor,
            ...mov
          });
        });
      });
      
      if (historialCompleto.length === 0) {
        document.getElementById("listaHistorial").innerHTML = '<p class="no-sabores">No hay movimientos registrados</p>';
        document.getElementById("modalHistorial").classList.remove("oculto");
        
        setTimeout(() => {
          const modal = document.getElementById("modalHistorial");
          const modalContent = modal.querySelector(".modal-content");
          modalContent.scrollTop = 0;
        }, 100);
        
        return;
      }
      
      diasConMovimientos = [...new Set(historialCompleto.map(mov => mov.fecha))];
      diasConMovimientos.sort((a, b) => new Date(b) - new Date(a));
      
      if (!fechaHistorialActual || !diasConMovimientos.includes(fechaHistorialActual)) {
        fechaHistorialActual = diasConMovimientos[0];
      }
      
      cargarMovimientosDia(fechaHistorialActual);
      document.getElementById("modalHistorial").classList.remove("oculto");
      
      setTimeout(() => {
        const modal = document.getElementById("modalHistorial");
        const modalContent = modal.querySelector(".modal-content");
        modalContent.scrollTop = 0;
      }, 100);
    }

    function cargarMovimientosDia(fecha) {
      const inventario = JSON.parse(localStorage.getItem("inventario_hielitos")) || {};
      const listaHistorial = document.getElementById("listaHistorial");
      
      let movimientosDelDia = [];
      Object.values(inventario).forEach(item => {
        if (item.historial) {
          item.historial.forEach(mov => {
            if (mov && mov.fecha === fecha) {
              movimientosDelDia.push({
                sabor: item.sabor,
                fecha: mov.fecha,
                hora: mov.hora || '00:00',
                cantidad: mov.cantidad,
                tipo: mov.tipo || 'entrada',
                stockResultante: mov.stockResultante
              });
            }
          });
        }
      });
      
      movimientosDelDia.sort((a, b) => {
        const horaA = a.hora || '00:00';
        const horaB = b.hora || '00:00';
        return horaB.localeCompare(horaA);
      });
      
      const fechaFormateada = fecha.split('-').reverse().join('/');
      document.getElementById("fechaActualHistorial").textContent = fechaFormateada;
      
      // CONFIGURAR EVENTOS DE BOTONES Y ACTUALIZAR ESTADO
      const indiceFechaActual = diasConMovimientos.indexOf(fecha);
      const btnAnterior = document.getElementById("btnDiaAnterior");
      const btnSiguiente = document.getElementById("btnDiaSiguiente");
      
      console.log(`Configurando botones - Índice: ${indiceFechaActual}, Total: ${diasConMovimientos.length}`);
      console.log(`Fecha mostrada: ${fecha}`);
      console.log(`Array de días:`, diasConMovimientos);
      
      // Limpiar eventos anteriores y agregar nuevos
      btnAnterior.onclick = null;
      btnSiguiente.onclick = null;
      
      // Calcular estado de botones
      const puedeIrAnterior = indiceFechaActual < diasConMovimientos.length - 1; // Puede ir a días más antiguos
      const puedeIrSiguiente = indiceFechaActual > 0; // Puede ir a días más recientes
      
      console.log(`Puede ir anterior (más antiguo): ${puedeIrAnterior}`);
      console.log(`Puede ir siguiente (más reciente): ${puedeIrSiguiente}`);
      
      // Configurar botón anterior (ir a día más antiguo)
      if (puedeIrAnterior) {
        btnAnterior.disabled = false;
        btnAnterior.onclick = () => cambiarDia(1); // +1 porque el array está ordenado de reciente a antiguo
        btnAnterior.style.backgroundColor = "#4ecdc4";
        btnAnterior.style.opacity = "1";
        btnAnterior.style.cursor = "pointer";
      } else {
        btnAnterior.disabled = true;
        btnAnterior.onclick = null;
        btnAnterior.style.backgroundColor = "#6c757d";
        btnAnterior.style.opacity = "0.6";
        btnAnterior.style.cursor = "not-allowed";
      }
      
      // Configurar botón siguiente (ir a día más reciente)
      if (puedeIrSiguiente) {
        btnSiguiente.disabled = false;
        btnSiguiente.onclick = () => cambiarDia(-1); // -1 porque el array está ordenado de reciente a antiguo
        btnSiguiente.style.backgroundColor = "#4ecdc4";
        btnSiguiente.style.opacity = "1";
        btnSiguiente.style.cursor = "pointer";
      } else {
        btnSiguiente.disabled = true;
        btnSiguiente.onclick = null;
        btnSiguiente.style.backgroundColor = "#6c757d";
        btnSiguiente.style.opacity = "0.6";
        btnSiguiente.style.cursor = "not-allowed";
      }
      
      // MOSTRAR CONTENIDO CON LAS MODIFICACIONES APLICADAS
      if (movimientosDelDia.length === 0) {
        listaHistorial.innerHTML = '<p class="no-sabores">No hay movimientos en esta fecha</p>';
      } else {
        // Agrupar movimientos por hora
        const movimientosPorHora = {};
        movimientosDelDia.forEach(mov => {
          const hora = mov.hora || '00:00';
          if (!movimientosPorHora[hora]) {
            movimientosPorHora[hora] = [];
          }
          movimientosPorHora[hora].push(mov);
        });
        
        // Crear HTML para cada hora
        const horasOrdenadas = Object.keys(movimientosPorHora).sort((a, b) => b.localeCompare(a));
        
        listaHistorial.innerHTML = horasOrdenadas.map(hora => {
          const movimientosHora = movimientosPorHora[hora];
          
          // Crear HTML para movimientos de esta hora CON MODIFICACIONES
          const itemsHTML = movimientosHora
            .filter(mov => {
              return mov && 
                     mov.sabor && 
                     mov.sabor.trim() !== '' &&
                     mov.cantidad !== null && 
                     mov.cantidad !== undefined &&
                     mov.cantidad !== '';
            })
            .map(mov => {
              const tipoClase = mov.tipo === 'entrada' ? 'item-cantidad-entrada' : 'item-cantidad-venta';
              const signo = mov.tipo === 'entrada' ? '+' : '';
              
              return `
                <div class="movimiento-item">
                  <div class="item-sabor-inventario">${mov.sabor}</div>
                  <div class="item-cantidad-inventario ${tipoClase}">${signo}${Math.abs(mov.cantidad)}</div>
                  <div class="item-stock-inventario">${mov.stockResultante}</div>
                </div>
              `;
            }).join('');
          
          // Calcular total de movimientos para esta hora Y determinar tipo predominante
          const totalMovimientos = movimientosHora.reduce((sum, mov) => sum + Math.abs(mov.cantidad), 0);
          const tiposMovimientos = movimientosHora.map(mov => mov.tipo || 'entrada');
          const soloEntradas = tiposMovimientos.every(tipo => tipo === 'entrada');
          const soloVentas = tiposMovimientos.every(tipo => tipo === 'venta');
          
          // Determinar clase CSS para el color del total
          let claseColorTotal = 'total-valor-mixto'; // Por defecto mixto (morado)
          if (soloEntradas) {
            claseColorTotal = 'total-valor-entradas'; // Verde/turquesa
          } else if (soloVentas) {
            claseColorTotal = 'total-valor-ventas'; // Rojo
          }
          
          return `
            <div class="movimiento-card">
              <!-- Fila de la hora -->
              <div class="movimiento-hora">
                ${hora}
              </div>
              
              <!-- Separador -->
              <div class="separador-inventario"></div>
              
              <!-- Movimientos de la hora -->
              <div class="movimientos-items">
                ${itemsHTML}
              </div>
              
              <!-- Separador -->
              <div class="separador-inventario"></div>
              
              <!-- Total de movimientos CON MODIFICACIONES: etiqueta a la derecha de sabores, valor en columna hielitos con color dinámico -->
              <div class="movimientos-totales">
                <div class="total-fila-inventario">
                  <div class="total-etiqueta-inventario">Total de hielitos:</div>
                  <div class="total-valor-inventario ${claseColorTotal}">${totalMovimientos}</div>
                  <div class="total-columna-vacia"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function cambiarDia(direccion) {
      const indiceActual = diasConMovimientos.indexOf(fechaHistorialActual);
      const nuevoIndice = indiceActual + direccion;
      
      console.log(`=== CAMBIAR DÍA ===`);
      console.log(`Dirección: ${direccion}`);
      console.log(`Índice actual: ${indiceActual}`);
      console.log(`Nuevo índice: ${nuevoIndice}`);
      console.log(`Total días: ${diasConMovimientos.length}`);
      console.log(`Días disponibles:`, diasConMovimientos);
      console.log(`Fecha actual: ${fechaHistorialActual}`);
      
      if (nuevoIndice >= 0 && nuevoIndice < diasConMovimientos.length) {
        fechaHistorialActual = diasConMovimientos[nuevoIndice];
        console.log(`✅ Cambiando a: ${fechaHistorialActual}`);
        cargarMovimientosDia(fechaHistorialActual);
      } else {
        console.log(`❌ Fuera de rango - no se puede cambiar`);
      }
    }

    function cerrarHistorial() {
      document.getElementById("modalHistorial").classList.add("oculto");
      fechaHistorialActual = null;
    }

    function confirmarBorradoInventario() {
      const confirmacion = confirm(
        "⚠️ ATENCIÓN ⚠️\n\nEsto borrará TODO el inventario (stock y historial).\nLos SABORES se mantendrán intactos.\n\n¿Estás seguro de continuar?"
      );
      if (confirmacion) {
        localStorage.removeItem("inventario_hielitos");
        alert("Inventario borrado correctamente.\nLos sabores se mantienen intactos.");
        cargarSabores();
      }
    }

    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("modal")) {
        cerrarModal();
        cerrarHistorial();
      }
    });

    window.addEventListener("DOMContentLoaded", cargarSabores);
  </script>
</body>
</html>