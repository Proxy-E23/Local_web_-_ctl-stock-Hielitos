<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sabores</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Sabores</h1>
  </header>

  <main class="container">
    <div class="botones-superiores">
      <button class="btn-volver" onclick="window.location.href='index.html'">‚Üê Atr√°s</button>
      <button class="btn-borrar" onclick="confirmarBorrado()">üóë Borrar todo</button>
    </div>
    <form id="saborForm">
      <label for="nombre">Sabor:</label>
      <input type="text" id="nombre" name="nombre" required />

      <label class="checkbox-label">
        <input type="checkbox" id="disponible" checked />
        Disponible para venta
      </label>

      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" required />

      <button type="submit">Agregar sabor</button>
      <button type="button" onclick="descargarJSON()">Descargar respaldo</button>
      <button type="button" onclick="document.getElementById('fileInput').click()">
        Cargar respaldo
      </button>
      <input type="file" id="fileInput" class="file-input" accept="application/json" onchange="cargarJSON(this)" />
    </form>

    <div class="lista-sabores">
      <h3>Sabores registrados:</h3>
      <div class="tabla-sabores">
        <div class="tabla-header">
          <div class="col-disponible">Estado</div>
          <div class="col-sabor">Sabor</div>
          <div class="col-fecha">Fecha</div>
        </div>
        <div id="listaSabores" class="tabla-body"></div>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById("saborForm");
    const fechaInput = document.getElementById("fecha");
    const listaSabores = document.getElementById("listaSabores");

    fechaInput.valueAsDate = new Date();

    function generarID(sabores) {
      let max = 0;
      sabores.forEach((s) => {
        const num = parseInt(s.id.replace("sh", ""));
        if (!isNaN(num) && num > max) max = num;
      });
      const next = (max + 1).toString().padStart(3, "0");
      return `sh${next}`;
    }

    function renderizarLista() {
      const sabores = JSON.parse(localStorage.getItem("shielitos")) || [];
      sabores.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
      listaSabores.innerHTML = "";
      
      if (sabores.length === 0) {
        listaSabores.innerHTML = '<div class="no-sabores">No hay sabores registrados</div>';
        return;
      }
      
      sabores.forEach(sabor => {
        // Convertir fecha de YYYY-MM-DD a DD/MM/YYYY
        const fechaFormateada = sabor.fecha.split('-').reverse().join('/');
        
        const fila = document.createElement("div");
        fila.className = "tabla-fila";
        fila.innerHTML = `
          <div class="col-disponible">
            <input type="checkbox" ${sabor.disponible ? 'checked' : ''} disabled />
          </div>
          <div class="col-sabor">${sabor.nombre}</div>
          <div class="col-fecha">${fechaFormateada}</div>
        `;
        listaSabores.appendChild(fila);
      });
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const nombre = document.getElementById("nombre").value.trim();
      const disponible = document.getElementById("disponible").checked;
      const fecha = document.getElementById("fecha").value;

      let sabores = JSON.parse(localStorage.getItem("shielitos")) || [];

      if (sabores.some((s) => s.nombre.toLowerCase() === nombre.toLowerCase())) {
        alert("Ese sabor ya existe.");
        return;
      }

      const id = generarID(sabores);
      sabores.push({ id, nombre, disponible, fecha });
      localStorage.setItem("shielitos", JSON.stringify(sabores));
      form.reset();
      fechaInput.valueAsDate = new Date();
      renderizarLista();
    });

    function descargarJSON() {
      const data = localStorage.getItem("shielitos");
      if (!data) {
        alert("No hay datos para respaldar.");
        return;
      }
      const hoy = new Date();
      const fecha = hoy.toLocaleDateString("es-MX").replace(/\//g, "-");
      const hora = hoy.getHours().toString().padStart(2, "0");
      const minuto = hoy.getMinutes().toString().padStart(2, "0");
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Sabores_Hielitos_-_${fecha}_-_${hora}-${minuto}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function cargarJSON(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) throw new Error();
          localStorage.setItem("shielitos", JSON.stringify(data));
          alert("Respaldo cargado correctamente.");
          renderizarLista();
        } catch {
          alert("Archivo no v√°lido.");
        }
      };
      reader.readAsText(file);
    }

    function confirmarBorrado() {
      const confirmacion = confirm(
        "Esto borrar√° TODOS los sabores guardados.\n\n¬øEst√°s seguro de continuar?"
      );
      if (confirmacion) {
        localStorage.removeItem("shielitos");
        alert("Sabores borrados correctamente.");
        renderizarLista();
      }
    }

    window.addEventListener("DOMContentLoaded", renderizarLista);
  </script>
</body>
</html>
